<?xml version="1.0" encoding="utf-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Register CAD Part">
  <!--//////////-->
  <BehaviorTree
    ID="Register CAD Part"
    _description="Load an STL from disk and use registration to align the pointcloud with a matching shape in the environment"
    _favorite="true"
    _subtreeOnly="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <Action ID="ClearSnapshot" />
      <SubTree ID="Look at table" _collapsed="true" />
      <Action
        ID="CreateStampedPose"
        position_xyz="0.02;.75;0.58"
        orientation_xyzw="0;0;0;1"
        stamped_pose="{stamped_pose}"
        name="Initial Guess"
        reference_frame="world"
      />
      <SubTree
        ID="Load Mesh as Red Pointcloud"
        _collapsed="false"
        output_cloud="{red_cloud}"
        initial_pose="{stamped_pose}"
        point_cloud="{red_cloud}"
      />
      <Action
        ID="SendPointCloudToUI"
        point_cloud="{red_cloud}"
        pcd_topic="/pcd_pointcloud_captures"
      />
      <Action
        ID="GetPointCloud"
        topic_name="/wrist_camera/points"
        message_out="{wrist_point_cloud}"
        timeout_sec="5.000000"
      />
      <Action
        ID="TransformPointCloudFrame"
        input_cloud="{wrist_point_cloud}"
        output_cloud="{wrist_point_cloud}"
        target_frame="world"
      />
      <Action
        ID="SendPointCloudToUI"
        point_cloud="{wrist_point_cloud}"
        pcd_topic="/pcd_pointcloud_captures"
      />
      <Action
        ID="RegisterPointClouds"
        target_point_cloud="{wrist_point_cloud}"
        base_point_cloud="{red_cloud}"
        max_correspondence_distance="0.5"
        max_iterations="100"
        target_pose_in_base_frame="{target_pose}"
      />
      <SubTree
        ID="Load Mesh as Green Pointcloud"
        _collapsed="false"
        output_cloud="{green_cloud}"
        initial_pose="{stamped_pose}"
        point_cloud="{green_cloud}"
      />
      <Action
        ID="TransformPointCloud"
        input_cloud="{green_cloud}"
        transform_pose="{target_pose}"
        output_cloud="{output_cloud_aligned}"
      />
      <Action
        ID="SendPointCloudToUI"
        point_cloud="{output_cloud_aligned}"
        pcd_topic="/pcd_pointcloud_captures"
      />
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Register CAD Part" />
  </TreeNodesModel>
</root>
