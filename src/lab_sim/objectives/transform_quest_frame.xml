<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Transform Quest Frame">
  <BehaviorTree ID="Transform Quest Frame" _description="This objective outputs the transformation from the end effector to an odom instance (right_controller_odom)">
    <Control ID="Sequence">
      <!--Get initial controller pose in quest frame (C₀)-->
      <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{controller_odom_at_calibration}"/>
      <Action ID="ConvertOdomToPoseStamped" odometry="{controller_odom_at_calibration}" pose_stamped="{controller_pose_at_calibration}"/>
      <!--Get initial EE pose in world frame (E₀)-->
      <SubTree ID="Get Transform Frame Pose" requested_frame="grasp_link" requested_pose="{ee_pose_at_calibration}"/>
      <!--Visualize both initial poses-->
      <Action ID="VisualizePose" pose="{ee_pose_at_calibration}" marker_text="EE" marker_name="init_ee_pose" _skipIf="true"/>
      <Action ID="VisualizePose" marker_name="init_controller_pose" marker_text="IC" pose="{controller_pose_at_calibration}"/>
      <!--Calculate offset from Controller to EE (this gives us quest→world transform)-->
      <!--At calibration: controller and EE are at same physical location-->
      <!--So: T_quest_to_world ≈ E₀ - C₀ (treating positions as vectors)-->
      <Action ID="CalculatePoseOffset" source_pose="{controller_pose_at_calibration}" destination_pose="{ee_pose_at_calibration}" source_to_destination_pose="{quest_to_world_offset}"/>
      <!--Convert the offset pose to vectors (bypasses frame_id checking)-->
      <SubTree ID="ConvertPoseStampedToVectors" pose_stamped="{quest_to_world_offset}" vec_position="{offset_position}" vec_quaternion="{offset_quaternion}"/>
      <!--Apply the transform to controller pose to verify it aligns with EE-->
      <Action ID="TransformPose" input_pose="{controller_pose_at_calibration}" translation_xyz="{offset_position}" quaternion_xyzw="{offset_quaternion}" output_pose="{transformed_controller_pose}"/>
      <!--Visualize transformed pose - should align with EE-->
      <Action ID="VisualizePose" pose="{transformed_controller_pose}" marker_text="ITP" marker_name="initial_transformed_pose" marker_size="0.100000"/>
      <!--Extract header from EE pose (has frame_id="world") and pose from offset-->
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_pose_at_calibration}" header="{world_header}" pose="{ee_pose}"/>
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{quest_to_world_offset}" header="{offset_header}" pose="{offset_pose}"/>
      <!--Create PoseStamped with world frame header and the offset pose-->
      <Action ID="CreatePoseStampedMessage" pose="{offset_pose}" header="{world_header}" pose_stamped="{quest_to_world_pose}"/>
      <Action ID="PublishStaticFrame" pose="{quest_to_world_pose}" child_frame_id="quest" _skipIf="true"/>
      <Action ID="ConvertPoseStampedToTransformStamped" pose_stamped="{quest_to_world_pose}" child_frame_id="quest" transform_stamped="{quest_to_world_transform}"/>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Transform Quest Frame">
      <inout_port name="transformed_controller_pose" default="{transformed_controller_pose}" type="geometry_msgs::msg::PoseStamped"/>
      <inout_port name="initial_controller_pose" default="{controller_pose_at_calibration}" type="geometry_msgs::msg::PoseStamped"/>
      <inout_port name="initial_ee_pose" default="{ee_pose_at_calibration}" type="geometry_msgs::msg::PoseStamped"/>
      <inout_port name="quest_to_world_transform" default="{quest_to_world_transform}" type="geometry_msgs::msg::TransformStamped"/>
    </SubTree>
  </TreeNodesModel>
</root>
