<?xml version="1.0" encoding="UTF-8" ?>
<root
  BTCPP_format="4"
  main_tree_to_execute="Plan and Execute generated grasp poses"
>
  <!--//////////-->
  <BehaviorTree
    ID="Plan and Execute generated grasp poses"
    _description="First generate cuboid grasp poses, plans and executes to that object"
    _favorite="true"
  >
    <Control ID="Sequence">
      <Action
        ID="CreateStampedPose"
        reference_frame="grasp_link"
        stamped_pose="{ee_to_tcp_tf}"
        position_xyz="0;0;0"
      />
      <Action
        ID="GenerateCuboidGraspPoses"
        ee_to_tcp_tf="{ee_to_tcp_tf}"
        end_effector_group_name="gripper"
        generate_x_axis_grasps="true"
        generate_y_axis_grasps="true"
        generate_z_axis_grasps="false"
        grasp_poses="{grasp_poses}"
        max_grasp_width="0.1"
        samples_per_quadrant="3"
        target_object="{cuboid_object}"
      />
      <Action
        ID="SolveIKQueries"
        check_collisions="true"
        ik_query_results="{ik_query_results}"
        joint_group_name="manipulator"
        timeout="0.010000"
        target_poses="{grasp_poses}"
      />
      <Action ID="ResetPoseStampedVector" vector="{ik_queries}" />
      <Decorator
        ID="ForEach"
        index="{index}"
        out="{out}"
        vector_in="{ik_query_results}"
      >
        <Control ID="Fallback">
          <Decorator ID="Precondition" else="FAILURE" if="out==1">
            <Control ID="Sequence">
              <Action
                ID="GetElementOfVector"
                element="{element}"
                index="{index}"
                vector_in="{grasp_poses}"
              />
              <Action
                ID="TransformPose"
                input_pose="{element}"
                output_pose="{transformed_pose}"
                translation_xyz="0.0;0.0;-0.1"
              />
              <Action
                ID="AddPoseStampedToVector"
                input="{transformed_pose}"
                vector="{ik_queries}"
              />
              <Action
                ID="VisualizePose"
                marker_lifetime="0.000000"
                marker_name="pose"
                marker_size="0.0500000"
                pose="{element}"
              />
              <Action ID="WaitForDuration" delay_duration="0.5" />
            </Control>
          </Decorator>
          <Action ID="AlwaysSuccess" />
        </Control>
      </Decorator>
      <Control ID="Sequence">
        <Action
          ID="InitializeMTCTask"
          task="{mtc_task}"
          timeout="-1.000000"
          trajectory_monitoring="false"
          controller_names="joint_trajectory_controller"
        />
        <Action ID="SetupMTCCurrentState" task="{mtc_task}" />
        <Action
          ID="SetupMTCConnectWithProRRT"
          acceleration_scale_factor="1.000000"
          keep_orientation="false"
          keep_orientation_link_names="grasp_link"
          keep_orientation_tolerance="0.100000"
          link_padding="0.000000"
          max_iterations="5000"
          planning_group_name="manipulator"
          seed="0"
          task="{mtc_task}"
          trajectory_sampling_rate="100"
          velocity_scale_factor="1.000000"
        />
        <Action
          ID="SetupMTCBatchPoseIK"
          end_effector_group="moveit_ee"
          end_effector_link="grasp_link"
          ik_group="manipulator"
          ik_timeout_s="0.01"
          max_ik_solutions="1"
          target_poses="{ik_queries}"
          task="{mtc_task}"
          monitored_stage="current state"
        />
        <Action ID="PlanMTCTask" solution="{mtc_solution}" task="{mtc_task}" />
        <Action
          ID="WaitForUserTrajectoryApproval"
          cartesian_path_links="grasp_link"
          solution="{mtc_solution}"
        />
        <Action
          ID="ExecuteMTCTask"
          goal_duration_tolerance="-1.000000"
          solution="{mtc_solution}"
        />
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Plan and Execute generated grasp poses">
      <MetadataFields>
        <Metadata subcategory="Application - Basic Examples" />
        <Metadata runnable="true" />
      </MetadataFields>
      <inout_port name="cuboid_object" default="{cuboid_object}" />
    </SubTree>
  </TreeNodesModel>
</root>
