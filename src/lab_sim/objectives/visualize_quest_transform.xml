<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Visualize Quest Transform">
  <BehaviorTree ID="Visualize Quest Transform">
    <Control ID="Sequence">
      <SubTree ID="Transform Quest Frame" _autoremap="true" _collapsed="false" initial_controller_pose="{controller_pose_at_calibration}"/>
      <!--Convert transform to pose for easier manipulation-->
      <Action ID="LogMessage" message="Made it past Transform Quest Frame :)"/>
      <!--Transform the initial controller pose to world frame (for delta calculation)-->
      <Action ID="TransformPoseFrame" input_pose="{controller_pose_at_calibration}" output_pose="{controller_pose_at_calibration_world}" target_frame_id="world"/>
      <!--Transform ITP to world frame before using it-->
      <Action ID="TransformPoseFrame" input_pose="{transformed_controller_pose}" output_pose="{transformed_controller_pose_world}" target_frame_id="world"/>
      <!--Unpack ITP to get position and header-->
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{transformed_controller_pose_world}" pose="{itp_pose}" header="{itp_header}"/>
      <Action ID="UnpackPoseMessage" pose="{itp_pose}" position="{itp_position}" orientation="{itp_orientation}"/>
      <!--Unpack ITP position to x, y, z for later addition-->
      <Action ID="UnpackPointMessage" point="{itp_position}" x="{itp_x}" y="{itp_y}" z="{itp_z}"/>
      <!--Create identity quaternion (no rotation)-->
      <Action ID="CreateQuaternionMessage" x="0.0" y="0.0" z="0.0" w="1.0" quaternion="{identity_quaternion}"/>
      <!--Create new pose with ITP position but no rotation-->
      <Action ID="CreatePoseMessage" position="{itp_position}" orientation="{identity_quaternion}" pose="{itp_pose_no_rotation}"/>
      <Action ID="CreatePoseStampedMessage" pose="{itp_pose_no_rotation}" header="{itp_header}" pose_stamped="{itp_no_rotation}"/>
      <!--Visualize ITP before the loop-->
      <Action ID="VisualizePose" marker_size="0.05" pose="{itp_no_rotation}" marker_text="ITP" marker_name="initial_transformed_pose"/>
      <Decorator ID="KeepRunningUntilFailure">
        <Control ID="Sequence">
          <!--Get current controller pose-->
          <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{odometry}"/>
          <Action ID="ConvertOdomToPoseStamped" odometry="{odometry}" pose_stamped="{current_controller_pose}"/>
          <Action ID="VisualizePose" marker_size="0.05" pose="{current_controller_pose}" marker_text="RC" marker_name="raw_controller_pose"/>
          <!--Transform current controller pose to world frame-->
          <Action ID="TransformPoseFrame" input_pose="{current_controller_pose}" output_pose="{current_controller_pose_world}" target_frame_id="world"/>
          <!--Calculate how much the controller has moved since calibration (both in world frame now)-->
          <Action ID="CalculatePoseOffset" source_pose="{controller_pose_at_calibration_world}" destination_pose="{current_controller_pose_world}" source_to_destination_pose="{controller_movement_delta_world}"/>
          <!--Unpack the delta to get translation and rotation separately-->
          <Action ID="UnpackPoseStampedMessage" pose_stamped="{controller_movement_delta_world}" pose="{delta_pose}" header="{delta_header}"/>
          <Action ID="UnpackPoseMessage" pose="{delta_pose}" position="{delta_position}" orientation="{delta_orientation}"/>
          <Action ID="UnpackPointMessage" point="{delta_position}" x="{delta_x}" y="{delta_y}" z="{delta_z}"/>
          <!--Add delta translation to ITP position using Script math (no rotation applied!)-->
          <Action ID="Script" code="target_x := itp_x + delta_x; target_y := itp_y + delta_y; target_z := itp_z + delta_z"/>
          <!--Create target position from added values-->
          <Action ID="CreatePointMessage" x="{target_x}" y="{target_y}" z="{target_z}" point="{target_position}"/>
          <!--Build final pose: translated position + delta rotation-->
          <Action ID="CreatePoseMessage" position="{target_position}" orientation="{delta_orientation}" pose="{target_pose}"/>
          <Action ID="CreatePoseStampedMessage" pose="{target_pose}" header="{itp_header}" pose_stamped="{target_controller_pose}"/>
          <!--Visualize the result - should track relative controller movement applied to ITP-->
          <Action ID="VisualizePose" marker_size="0.05" pose="{target_controller_pose}" marker_text="TC" marker_name="transformed_controller_pose"/>
        </Control>
      </Decorator>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Visualize Quest Transform"/>
  </TreeNodesModel>
</root>
