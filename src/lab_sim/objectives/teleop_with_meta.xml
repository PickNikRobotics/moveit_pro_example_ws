<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Teleop With Meta">
  <BehaviorTree ID="Teleop With Meta" _description="Listens to grasp topic from controller. When controller grasp is toggled, we save the controller odom position and use that to republish those messages to the controller in the end effector frame " _favorite="true">
    <Decorator ID="KeepRunningUntilFailure">
      <Control ID="Sequence" name="TopLevelSequence">
        <SubTree ID="Look at Table" _collapsed="true"/>
        <!--Step 1: Wait for grip button press while capturing controller pose (in native controller frame) as zero point-->
        <!--This captures the EE pose ONCE at the moment the clutch is pressed-->
        <SubTree ID="TransformQuestFrame" _collapsed="true" button_topic="right_grip_button_event"/>
        <!--Initialize all state variables - use separate boolean for tracking readiness-->
        <Action ID="Script" code="current_grip := false; prev_grip_state := false; offset_calculated := false; tracking_active := false"/>
        <!--Initialize offset values to prevent "variable not found" error-->
        <Action ID="Script" code="offset_x := 0.0; offset_y := 0.0; offset_z := 0.0"/>
        <Action ID="SetBlackboard" value="false" output_key="subscribed_bool"/>
        <!--Initialize transformed_odom with current EE pose-->
        <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{init_ee_transform}"/>
        <Action ID="ConvertTransformStampedToPoseStamped" pose_stamped="{init_ee_pose_stamped}" transform_stamped="{init_ee_transform}"/>
        <Action ID="ConvertPoseStampedToOdom" child_frame="grasp_link" odom="{transformed_odom}" pose_stamped="{init_ee_pose_stamped}"/>
        <!--Publish initial odom multiple times to ensure Track Moving Frame receives it-->
        <Control ID="Parallel" success_count="-1" failure_count="1">
          <!--Branch 1: Monitor grip button state continuously-->
          <Action ID="GetBool" bool_topic_name="right_grip_button_state" subscribed_bool="{subscribed_bool}"/>
          <!--Branch 2: Rising Edge Detection - updates rising_edge when grip goes false->true-->
          <SubTree ID="Rising Edge Detection" bool_topic="right_grip_button_state" current_state="{edge_current_state}" rising_edge="{grip_rising_edge}"/>
          <!--Branch 3: Main control loop - calculates offset and publishes transformed poses-->
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <!--Small delay to let GetBool and Rising Edge Detection update-->
              <Action ID="WaitForDuration" delay_duration="0.05"/>
              <!--Store current grip state-->
              <Action ID="Script" code="current_grip := subscribed_bool"/>
              <!--Rising edge detection: when grip_rising_edge is true, snap to EE position-->
              <Decorator ID="Precondition" else="SUCCESS" if="grip_rising_edge">
                <Control ID="Sequence" _collapsed="true">
                  <Action ID="LogMessage" message="Rising edge detected - snapping to end effector position"/>
                  <!--Get current EE pose FIRST (this is what we want to align to)-->
                  <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{ee_transform}"/>
                  <Action ID="ConvertTransformStampedToPoseStamped" pose_stamped="{ee_pose_stamped}" transform_stamped="{ee_transform}"/>
                  <!--Extract EE position and orientation-->
                  <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_pose_stamped}" pose="{ee_pose}" header="{ee_header}"/>
                  <Action ID="UnpackPoseMessage" pose="{ee_pose}" orientation="{ee_orientation}" position="{ee_position}"/>
                  <Action ID="UnpackPointMessage" point="{ee_position}" x="{ee_x}" y="{ee_y}" z="{ee_z}"/>
                  <!--Get current controller pose at this exact moment-->
                  <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                  <Action ID="ConvertOdomToPoseStamped" odometry="{current_controller_odom}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="UnpackPoseStampedMessage" pose="{inst_pose}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="UnpackPoseMessage" pose="{inst_pose}" orientation="{inst_orientation}" position="{inst_position}"/>
                  <Action ID="UnpackPointMessage" point="{inst_position}" x="{ctrl_init_x}" y="{ctrl_init_y}" z="{ctrl_init_z}"/>
                  <!--Calculate POSITION OFFSET: EE position - Controller position-->
                  <!--This is the translation we need to add to controller position to get EE position-->
                  <Action ID="Script" code="offset_x := ee_x - ctrl_init_x; offset_y := ee_y - ctrl_init_y; offset_z := ee_z - ctrl_init_z"/>
                  <!--Mark offset as calculated AND activate tracking-->
                  <Action ID="Script" code="offset_calculated := true; tracking_active := true"/>
                  <!--Update transformed_odom blackboard variable with current EE pose-->
                  <Action ID="ConvertPoseStampedToOdom" child_frame="grasp_link" odom="{transformed_odom}" pose_stamped="{ee_pose_stamped}"/>
                  <!--Publish so Track Moving Frame gets the update-->
                  <Action ID="PublishOdom" message="{transformed_odom}" topic_name="tracking_odom"/>
                  <Action ID="LogMessage" message="Position offset calculated and stored (rotation passes through directly)"/>
                </Control>
              </Decorator>
              <!--Update previous grip state AFTER the checks-->
              <Action ID="Script" code="prev_grip_state := current_grip"/>
              <!--Only transform when grip is held AND offset has been calculated-->
              <Decorator ID="Precondition" else="SUCCESS" if="current_grip &amp;&amp; offset_calculated">
                <Control ID="Sequence">
                  <!--Get current controller odom-->
                  <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                  <Action ID="ConvertOdomToPoseStamped" pose_stamped="{tmp_controller_pose_stamped}" odometry="{current_controller_odom}"/>
                  <Action ID="UnpackPoseStampedMessage" header="{header}" pose="{inst_pose}" pose_stamped="{tmp_controller_pose_stamped}"/>
                  <!--Extract controller position and rotation-->
                  <Action ID="UnpackPoseMessage" pose="{inst_pose}" orientation="{ctrl_orientation}" position="{ctrl_position}"/>
                  <Action ID="UnpackPointMessage" point="{ctrl_position}" x="{ctrl_x}" y="{ctrl_y}" z="{ctrl_z}"/>
                  <!--Apply position offset: new_position = controller_position + offset-->
                  <Action ID="Script" code="trans_x := ctrl_x + offset_x; trans_y := ctrl_y + offset_y; trans_z := ctrl_z + offset_z"/>
                  <!--Build transformed position-->
                  <Action ID="CreatePointMessage" point="{trans_position}" x="{trans_x}" y="{trans_y}" z="{trans_z}"/>
                  <!--Build pose with: offset position + controller rotation (pass-through)-->
                  <Action ID="CreatePoseMessage" pose="{trans_pose}" orientation="{ctrl_orientation}" position="{trans_position}"/>
                  <!--Create header-->
                  <Action ID="CreateTimeMessage" sec="0" nanosec="0" time="{odom_time}"/>
                  <Action ID="CreateHeaderMessage" stamp="{odom_time}" frame_id="world" header="{odom_header}"/>
                  <Action ID="CreatePoseStampedMessage" header="{odom_header}" pose_stamped="{transformed_pose_stamped}" pose="{trans_pose}"/>
                  <!--=== COLLISION CHECK: Verify pose is safe before updating ===-->
                  <Action ID="ResetPoseStampedVector" vector="{ik_check_poses}"/>
                  <Action ID="AddPoseStampedToVector" input="{transformed_pose_stamped}" vector="{ik_check_poses}"/>
                  <Action ID="SolveIKQueries" target_poses="{ik_check_poses}" check_collisions="true" timeout="0.02" joint_group_name="manipulator" ik_query_results="{ik_results}"/>
                  <Action ID="GetElementOfVector" vector_in="{ik_results}" index="0" element="{pose_is_safe}"/>
                  <!--Only update blackboard odom if pose is collision-free-->
                  <Action ID="Script" code="tracking_active := true"/>
                  <Decorator ID="Precondition" if="pose_is_safe" else="SUCCESS">
                    <Control ID="Sequence">
                      <!--Visualize only safe poses-->
                      <Action ID="VisualizePose" marker_name="safe_target_pose" pose="{transformed_pose_stamped}" marker_text="FP" marker_lifetime="0.000000"/>
                      <!--Update blackboard variable (NOT publishing to topic)-->
                      <Action ID="ConvertPoseStampedToOdom" child_frame="grasp_link" odom="{transformed_odom}" pose_stamped="{transformed_pose_stamped}"/>
                      <!--Publish to topic so Track Moving Frame can subscribe-->
                      <Action ID="PublishOdom" message="{transformed_odom}" topic_name="tracking_odom"/>
                      <Action ID="PublishPose" message="{transformed_pose_stamped}" topic_name="tracking_pose"/>
                    </Control>
                  </Decorator>
                </Control>
              </Decorator>
              <!--When grip is released, deactivate tracking-->
              <Decorator ID="Precondition" else="SUCCESS" if="!current_grip &amp;&amp; offset_calculated">
                <Action ID="Script" code="tracking_active := false"/>
              </Decorator>
            </Control>
          </Decorator>
          <!--Branch 4: Track Moving Frame - uses tracking_active which stays true while grip held-->
          <!--tracking_active is set true on rising edge and stays true until grip released-->
          <Decorator ID="Precondition" else="RUNNING" if="tracking_active">
            <SubTree ID="Track Moving Frame" odometry_topic_name="tracking_odom" default_ik_frame="grasp_link" proportional_gain_linear="2.0" proportional_gain_angular="2.0"/>
          </Decorator>
          <!--Branch 5: Keep tracking_odom subscription alive so Track Moving Frame receives messages immediately when activated-->
          <Action ID="GetOdom" odometry_topic_name="tracking_odom"/>
        </Control>
      </Control>
    </Decorator>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Teleop With Meta"/>
  </TreeNodesModel>
</root>
