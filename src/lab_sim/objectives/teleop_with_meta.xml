<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Teleop With Meta">
  <BehaviorTree ID="Teleop With Meta" _description="Listens to grasp topic from controller. When controller grasp is toggled, we save the controller odom position and use that to republish those messages to the controller in the end effector frame " _favorite="true">
    <Decorator ID="KeepRunningUntilFailure">
      <Control ID="Sequence" name="TopLevelSequence">
        <!--Step 1: Wait for grip button press while capturing controller pose (in native controller frame) as zero point-->
        <!--This captures the EE pose ONCE at the moment the clutch is pressed-->
        <SubTree ID="TransformQuestFrame" _collapsed="true"/>
        <!--Step 2: While grip is held, continuously transform and publish using the captured offset-->
        <Action ID="SetBlackboard" value="false" output_key="subscribed_bool"/>
        <Action ID="SetBlackboard" output_key="transformed_odom_received" value="false"/>
        <!--Initialize previous grip state for rising edge detection (true so first iteration doesn't trigger)-->
        <Action ID="Script" code="prev_grip_state := true"/>
        <Control ID="Parallel" success_count="-1" failure_count="1">
          <!--Monitor grip button state - will fail the parallel when grip is released-->
          <Action ID="GetBool" bool_topic_name="right_grip_button_state" subscribed_bool="{subscribed_bool}"/>
          <!--Continuous transform loop-->
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <!--Rising edge detection: recompute pose offset when grip goes false->true-->
              <Decorator ID="Precondition" else="SUCCESS" if="!prev_grip_state &amp;&amp; subscribed_bool">
                <Control ID="Sequence">
                  <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{ee_transform}"/>
                  <Action ID="ConvertTransformStampedToPoseStamped" pose_stamped="{ee_pose_stamped}" transform_stamped="{ee_transform}"/>
                  <!--Remove the rotation from the EE transform-->
                  <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_pose_stamped}" pose="{ee_pose}" header="{ee_header}"/>
                  <Action ID="UnpackPoseMessage" pose="{ee_pose}" orientation="{ee_orientation}" position="{ee_position}"/>
                  <!--Rebuild the EE pose sans rotation as pose stamped message-->
                  <Action ID="CreateQuaternionMessage" quaternion="{identity_rotation}" w="1.0" x="0.0" y="0.0" z="0.0"/>
                  <Action ID="CreatePoseMessage" orientation="{identity_rotation}" pose="{ee_pose_sans_rotation}" position="{ee_position}"/>
                  <Action ID="CreatePoseStampedMessage" header="{ee_header}" pose="{ee_pose_sans_rotation}" pose_stamped="{ee_pose_stamped_sans_rotation}"/>
                  <!--Unpack the controller odometry topic to get it into a common frame-->
                  <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                  <Action ID="ConvertOdomToPoseStamped" odometry="{current_controller_odom}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="UnpackPoseStampedMessage" pose="{inst_pose}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="CreateTimeMessage" nanosec="1" sec="1" time="{inst_time}"/>
                  <Action ID="CreateHeaderMessage" frame_id="world" header="{inst_header}" stamp="{inst_time}"/>
                  <Action ID="CreatePoseStampedMessage" header="{inst_header}" pose="{inst_pose}" pose_stamped="{inst_controller_common}"/>
                  <Action ID="LogMessage" message="Recomputing transform between controller and end effector."/>
                  <Action ID="CalculatePoseOffset" destination_pose="{ee_pose_stamped_sans_rotation}" source_pose="{inst_controller_common}" source_to_destination_pose="{controller_to_EE_pose}"/>
                </Control>
              </Decorator>
              <Action ID="Script" code="prev_grip_state := subscribed_bool"/>
              <!--Only do transform work when grip is held-->
              <Decorator ID="Precondition" else="SUCCESS" if="subscribed_bool">
                <Control ID="Parallel" failure_count="1" success_count="-1">
                  <!--Continuously publish transformed odom while grip is held-->
                  <Decorator ID="KeepRunningUntilFailure">
                    <Control ID="Sequence">
                      <!--Get current controller odom (in native controller frame - same as zero point)-->
                      <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                      <Action ID="ConvertOdomToPoseStamped" pose_stamped="{tmp_controller_pose_stamped}" odometry="{current_controller_odom}"/>
                      <Action ID="UnpackPoseStampedMessage" header="{header}" pose="{inst_pose}" pose_stamped="{tmp_controller_pose_stamped}"/>
                      <Action ID="CreateTimeMessage" sec="1" nanosec="1" time="{inst_time}"/>
                      <Action ID="CreateHeaderMessage" stamp="{inst_time}" frame_id="world" header="{inst_header}"/>
                      <Action ID="CreatePoseStampedMessage" header="{inst_header}" pose="{inst_pose}" pose_stamped="{inst_controller_pose_common}"/>
                      <Action ID="TransformPoseWithPose" input_pose="{controller_to_EE_pose}" transform_pose="{inst_controller_pose_common}" output_pose="{transformed_pose}"/>
                      <Action ID="VisualizePose" marker_name="trans_pose" pose="{transformed_pose}" marker_text="TP"/>
                      <Action ID="ConvertPoseStampedToOdom" child_frame="child_frame" odom="{transformed_odom}" pose_stamped="{transformed_pose}"/>
                      <Action ID="PublishOdom" message="{transformed_odom}" topic_name="transformed_odom"/>
                      <Action ID="SetBlackboard" value="true" output_key="transformed_odom_received"/>
                      <!--Small delay between publish iterations-->
                      <Action ID="Sleep" msec="20"/>
                    </Control>
                  </Decorator>
                  <SubTree ID="Track Moving Frame" _collapsed="true" odometry_topic_name="transformed_odom" proportional_gain_linear="2.0"/>
                </Control>
              </Decorator>
              <!--Small delay between iterations to control update rate-->
              <Action ID="Sleep" msec="50"/>
            </Control>
          </Decorator>
        </Control>
        <!--Step 3: Grip released - parallel failed, sequence will restart from waiting for grip press-->
      </Control>
    </Decorator>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Teleop With Meta"/>
  </TreeNodesModel>
</root>
