<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Teleop With Meta">
  <BehaviorTree ID="Teleop With Meta" _description="Listens to grasp topic from controller. When controller grasp is toggled, we save the controller odom position and use that to republish those messages to the controller in the end effector frame " _favorite="true">
    <Decorator ID="KeepRunningUntilFailure">
      <Control ID="Sequence" name="TopLevelSequence">
        <!--Step 1: Wait for grip button press while capturing controller pose (in native controller frame) as zero point-->
        <!--This captures the EE pose ONCE at the moment the clutch is pressed-->
        <SubTree ID="TransformQuestFrame" _collapsed="true" button_topic="right_grip_button_event"/>
        <Action ID="Script" code="current_grip := false"/>
        <!--Step 2: While grip is held, continuously transform and publish using the captured offset-->
        <Action ID="SetBlackboard" value="false" output_key="subscribed_bool"/>
        <!--Initialize previous grip state and odom received flag as booleans-->
        <Action ID="Script" code="prev_grip_state := false; transformed_odom_received := false"/>
        <Control ID="Parallel" success_count="-1" failure_count="1">
          <!--Monitor grip button state continuously-->
          <Action ID="GetBool" bool_topic_name="right_grip_button_state" subscribed_bool="{subscribed_bool}"/>
          <!--Main control loop-->
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <!--Small delay to let GetBool update-->
              <Action ID="Sleep" msec="50"/>
              <!--Store current grip state in a temp variable for comparison-->
              <Action ID="Script" code="current_grip := subscribed_bool"/>
              <!--Rising edge detection: when grip goes false->true, snap to EE position-->
              <Decorator ID="Precondition" else="SUCCESS" if="!prev_grip_state &amp;&amp; current_grip">
                <Control ID="Sequence" _collapsed="true">
                  <Action ID="LogMessage" message="Grip pressed - snapping to end effector position"/>
                  <!--Get current EE pose-->
                  <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{ee_transform}"/>
                  <Action ID="ConvertTransformStampedToPoseStamped" pose_stamped="{ee_pose_stamped}" transform_stamped="{ee_transform}"/>
                  <!--Extract EE position-->
                  <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_pose_stamped}" pose="{ee_pose}" header="{ee_header}"/>
                  <Action ID="UnpackPoseMessage" pose="{ee_pose}" orientation="{ee_orientation}" position="{ee_position}"/>
                  <Action ID="UnpackPointMessage" point="{ee_position}" x="{ee_x}" y="{ee_y}" z="{ee_z}"/>
                  <!--Get current controller pose-->
                  <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                  <Action ID="ConvertOdomToPoseStamped" odometry="{current_controller_odom}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="UnpackPoseStampedMessage" pose="{inst_pose}" pose_stamped="{tmp_controller_pose}"/>
                  <Action ID="UnpackPoseMessage" pose="{inst_pose}" orientation="{inst_orientation}" position="{inst_position}"/>
                  <Action ID="UnpackPointMessage" point="{inst_position}" x="{ctrl_init_x}" y="{ctrl_init_y}" z="{ctrl_init_z}"/>
                  <!--Calculate POSITION OFFSET ONLY: EE position - Controller position-->
                  <!--This is the translation we need to add to controller position to get EE position-->
                  <Action ID="Script" code="offset_x := ee_x - ctrl_init_x; offset_y := ee_y - ctrl_init_y; offset_z := ee_z - ctrl_init_z"/>
                  <Action ID="LogMessage" message="Position offset calculated and stored (rotation will pass through directly)"/>
                </Control>
              </Decorator>
              <!--Update previous grip state AFTER the check-->
              <Action ID="Script" code="prev_grip_state := current_grip"/>
              <!--Only transform and track when grip is held-->
              <Decorator ID="Precondition" else="SUCCESS" if="current_grip">
                <Control ID="Sequence">
                  <!--Get current controller odom-->
                  <Action ID="GetOdomInstance" odom_topic_name="right_controller_odom" subscribed_odom_instance="{current_controller_odom}"/>
                  <Action ID="ConvertOdomToPoseStamped" pose_stamped="{tmp_controller_pose_stamped}" odometry="{current_controller_odom}"/>
                  <Action ID="UnpackPoseStampedMessage" header="{header}" pose="{inst_pose}" pose_stamped="{tmp_controller_pose_stamped}"/>
                  <!--Extract controller position and rotation-->
                  <Action ID="UnpackPoseMessage" pose="{inst_pose}" orientation="{ctrl_orientation}" position="{ctrl_position}"/>
                  <Action ID="UnpackPointMessage" point="{ctrl_position}" x="{ctrl_x}" y="{ctrl_y}" z="{ctrl_z}"/>
                  <!--Apply position offset: new_position = controller_position + offset-->
                  <Action ID="Script" code="trans_x := ctrl_x + offset_x; trans_y := ctrl_y + offset_y; trans_z := ctrl_z + offset_z"/>
                  <!--Build transformed position-->
                  <Action ID="CreatePointMessage" point="{trans_position}" x="{trans_x}" y="{trans_y}" z="{trans_z}"/>
                  <!--Build pose with: offset position + controller rotation (pass-through)-->
                  <Action ID="CreatePoseMessage" pose="{trans_pose}" orientation="{ctrl_orientation}" position="{trans_position}"/>
                  <!--Create header-->
                  <Action ID="CreateTimeMessage" sec="0" nanosec="0" time="{odom_time}"/>
                  <Action ID="CreateHeaderMessage" stamp="{odom_time}" frame_id="world" header="{odom_header}"/>
                  <Action ID="CreatePoseStampedMessage" header="{odom_header}" pose_stamped="{transformed_pose_stamped}" pose="{trans_pose}"/>
                  <Action ID="VisualizePose" marker_name="trans_pose" pose="{transformed_pose_stamped}" marker_text="TP" _skipIf="true"/>
                  <!--Visualize the final pose-->
                  <Action ID="VisualizePose" marker_name="flipped_trans_pose" pose="{transformed_pose_stamped}" marker_text="FP" marker_lifetime="0.000000"/>
                  <!--=== COLLISION CHECK: Verify pose is safe before publishing ===-->
                  <!--Create a vector with just this pose for SolveIKQueries-->
                  <Action ID="ResetPoseStampedVector" vector="{ik_check_poses}"/>
                  <Action ID="AddPoseStampedToVector" input="{transformed_pose_stamped}" vector="{ik_check_poses}"/>
                  <!--Check if pose is reachable AND collision-free-->
                  <Action ID="SolveIKQueries" target_poses="{ik_check_poses}" check_collisions="true" timeout="0.02" joint_group_name="manipulator" ik_query_results="{ik_results}"/>
                  <!--Get the result (first element of the results vector)-->
                  <Action ID="GetElementOfVector" vector_in="{ik_results}" index="0" element="{pose_is_safe}"/>
                  <!--Only publish odom and set flag if pose is collision-free-->
                  <Decorator ID="Precondition" if="pose_is_safe" else="SUCCESS">
                    <Control ID="Sequence">
                      <!--Publish transformed odom for Track Moving Frame to consume-->
                      <Action ID="ConvertPoseStampedToOdom" child_frame="grasp_link" odom="{transformed_odom}" pose_stamped="{transformed_pose_stamped}"/>
                      <Action ID="PublishOdom" message="{transformed_odom}" topic_name="transformed_odom"/>
                      <!--Set flag that we have published odom (as boolean)-->
                      <Action ID="Script" code="transformed_odom_received := true"/>
                      <!--Save the last safe odom message to republish when clutch is released-->
                      <Action ID="Script" code="last_safe_odom_msg := transformed_odom"/>
                    </Control>
                  </Decorator>
                </Control>
              </Decorator>
              <!--DEBUG: Log current state after each loop iteration-->
              <Action ID="LogMessage" message="[DEBUG] Main loop: checking grip states..."/>
            </Control>
          </Decorator>
          <!--Track the moving frame when clutch is released - republish last safe pose to prevent droop-->
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <Action ID="Sleep" msec="50"/>
              <!--DEBUG: Log that we're checking the anti-droop condition-->
              <Action ID="LogMessage" message="[DEBUG] Anti-droop branch: checking falling edge..."/>
              <Decorator ID="Precondition" else="SUCCESS" if="prev_grip_state &amp;&amp; !current_grip &amp;&amp; transformed_odom_received">
                <Control ID="Sequence">
                  <Action ID="LogMessage" message="[DEBUG] FALLING EDGE DETECTED - Grip released, publishing last safe odom!"/>
                  <Action ID="PublishOdom" message="{last_safe_odom_msg}" topic_name="last_odom_msg"/>
                  <Action ID="LogMessage" message="Publishing to last_odom_msg to avoid droopage!"/>
                  <SubTree ID="Track Moving Frame" odometry_topic_name="last_odom_msg" proportional_gain_linear="2.0" proportional_gain_angular="2.0"/>
                </Control>
              </Decorator>
            </Control>
          </Decorator>
          <!--This is to avoid drooping after releasing the clutch. Republish last safe message on loop until the user presses the clutch again.-->
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <!--Small delay to sync with main loop updates-->
              <Action ID="Sleep" msec="50"/>
              <!--DEBUG: Log the current grip and odom state-->
              <Action ID="LogMessage" message="[DEBUG] Track branch: checking grip held condition..."/>
              <!--Only track when we have data AND grip is currently held-->
              <Decorator ID="Precondition" if="transformed_odom_received &amp;&amp; current_grip" else="SUCCESS">
                <Control ID="Sequence">
                  <Action ID="LogMessage" message="[DEBUG] TRACKING - Grip held and odom received, calling Track Moving Frame"/>
                  <SubTree ID="Track Moving Frame" _collapsed="true" proportional_gain_linear="2.0" odometry_topic_name="transformed_odom"/>
                </Control>
              </Decorator>
            </Control>
          </Decorator>
        </Control>
        <!--Step 3: Grip released - parallel failed, sequence will restart from waiting for grip press-->
      </Control>
    </Decorator>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Teleop With Meta"/>
  </TreeNodesModel>
</root>
