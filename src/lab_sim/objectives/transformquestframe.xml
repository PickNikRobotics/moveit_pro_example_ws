<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="TransformQuestFrame">
  <BehaviorTree ID="TransformQuestFrame" _description="Listens to grasp topic from controller. When controller grasp is toggled, we save the controller odom position and use that to republish those messages to the controller in the end effector frame " _favorite="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <!--Wait for grip button press while capturing controller odom-->
      <Control ID="Parallel" failure_count="1" success_count="1">
        <Action ID="GetOdom" odometry_pose="{controller_clutched_pose}" odometry_topic_name="/right_controller_odom" subscribed_odometry="{subscribed_odometry}"/>
        <Action ID="GetEmpty" empty_topic_name="/right_grip_button_event"/>
      </Control>
      <!--Get the EE pose at clutch moment-->
      <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{ee_transform}"/>
      <Action ID="ConvertTransformStampedToPoseStamped" transform_stamped="{ee_transform}" pose_stamped="{ee_clutched_pose}"/>
      <!--Extract pose data from both poses (ignoring frame_ids)-->
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_clutched_pose}" header="{ee_header}" pose="{ee_pose}"/>
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{controller_clutched_pose}" header="{controller_header}" pose="{controller_pose}"/>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="TransformQuestFrame">
      <inout_port name="raw_controller_pose" default="{controller_pose}"/>
      <inout_port name="raw_ee_pose" default="{ee_pose}"/>
    </SubTree>
  </TreeNodesModel>
</root>
