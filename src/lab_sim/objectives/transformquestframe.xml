<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="TransformQuestFrame">
  <BehaviorTree ID="TransformQuestFrame" _description="Listens to grasp topic from controller. When controller grasp is toggled, we save the controller odom position and use that to republish those messages to the controller in the end effector frame " _favorite="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <!--Wait for grip button press while capturing controller odom-->
      <Control ID="Parallel" failure_count="1" success_count="1">
        <Action ID="GetOdom" subscribed_odometry="{subscribed_odometry}" odometry_pose="{raw_controller_pose}" odometry_topic_name="{controller_odometry_topic}"/>
        <Action ID="GetEmpty" empty_topic_name="{button_topic}" message_count="{message_count}"/>
      </Control>
      <!--Get the EE pose at clutch moment-->
      <Action ID="GetLatestTransform" source_frame_id="grasp_link" target_frame_id="world" transform="{ee_transform}"/>
      <Action ID="ConvertTransformStampedToPoseStamped" transform_stamped="{ee_transform}" pose_stamped="{ee_pose_stamped}"/>
      <!--Remove the rotation from the transform-->
      <Action ID="UnpackPoseStampedMessage" pose_stamped="{ee_pose_stamped}" pose="{ee_pose}" header="{ee_header}"/>
      <Action ID="UnpackPoseMessage" pose="{ee_pose}" orientation="{ee_orientation}" position="{ee_position}"/>
      <!--Rebuild the ee pose sans rotation as pose stamped message-->
      <Action ID="CreateQuaternionMessage" quaternion="{identity_orientation}" w="1.0" x="0.0" z="0.0" y="0.0"/>
      <Action ID="CreatePoseMessage" orientation="{identity_orientation}" pose="{ee_pose_sans_rotation}" position="{ee_position}"/>
      <Action ID="CreatePoseStampedMessage" header="{ee_header}" pose_stamped="{ee_pose_stamped_sans_rotation}" pose="{ee_pose_sans_rotation}"/>
      <!--Deconstruct the controller message to get in a common frame-->
      <Action ID="UnpackPoseStampedMessage" header="{quest_header}" pose="{controller_pose}" pose_stamped="{raw_controller_pose}"/>
      <Action ID="CreateTimeMessage" nanosec="0" sec="0" time="{dummy_stamp}"/>
      <Action ID="CreateHeaderMessage" frame_id="world" header="{dummy_header}" stamp="{dummy_stamp}"/>
      <!--Reconstruct controller pose message in the common frame (so that CalculatePoseOffset works)-->
      <Action ID="CreatePoseStampedMessage" header="{dummy_header}" pose="{controller_pose}" pose_stamped="{controller_common_frame}"/>
      <Action ID="CalculatePoseOffset" destination_pose="{ee_pose_stamped_sans_rotation}" source_pose="{controller_common_frame}" source_to_destination_pose="{transform_pose}"/>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="TransformQuestFrame">
      <inout_port name="button_topic" default="right_grip_button_event" type="std::string"/>
      <inout_port name="controller_odometry_topic" default="right_controller_odom" type="std::string"/>
      <inout_port name="transform_pose" default="{transform_pose}" type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
    </SubTree>
  </TreeNodesModel>
</root>
