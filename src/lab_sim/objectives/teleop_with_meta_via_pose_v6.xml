<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Teleop With Meta via Pose v6">
  <BehaviorTree ID="Teleop With Meta via Pose v6" _description="Add clutch-in behavior" _favorite="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <!--Initial Setup-->
      <Control ID="Sequence" name="InitialSetup">
        <!--Initialize target_pose to current end effector (but tracking won't start until clutch)-->
        <Action ID="CreateStampedPose" reference_frame="grasp_link" stamped_pose="{initial_grasp_pose}" name="Get current pose of grasp_link"/>
        <Action ID="TransformPoseFrame" input_pose="{initial_grasp_pose}" output_pose="{initial_grasp_pose}" target_frame_id="world"/>
        <Action ID="TransformPoseFrame" input_pose="{initial_grasp_pose}" output_pose="{target_pose}" target_frame_id="world"/>
        <Action ID="VisualizePose" pose="{initial_grasp_pose}" marker_name="initial grasp pose" marker_size="0.100000" marker_text="i_g"/>
        <!--Get initial controller pose in WORLD frame-->
        <Action ID="GetOdomInstance" odom_topic_name="/right_controller_odom" subscribed_odom_instance="{odometry}" name="Get initial controller pose"/>
        <Action ID="ConvertOdomToPoseStamped" pose_stamped="{initial_controller_pose}" odometry="{odometry}"/>
        <Action ID="TransformPoseFrame" input_pose="{initial_controller_pose}" output_pose="{initial_controller_pose}" target_frame_id="world"/>
        <Action ID="VisualizePose" pose="{initial_controller_pose}" marker_name="initial controller pose" marker_text="i_c"/>
      </Control>
      <Action ID="SwitchController" activate_controllers="velocity_force_controller"/>
      <Control ID="Sequence" name="Initial values">
        <Action ID="CreateStampedWrench"/>
        <Action ID="CreateStampedTwist" reference_frame="world"/>
        <!--Initialize grip state tracking AND tracking_enabled flag-->
        <Action ID="Script" code="prev_grip := false; current_grip := false; rising_edge_detected := false; tracking_enabled := false"/>
      </Control>
      <!--Main Control Loop: Parallel with publisher-->
      <Control ID="Parallel" failure_count="1" success_count="2">
        <!--Branch 1: Main loop - poll button, detect edges, compute target-->
        <Decorator ID="KeepRunningUntilFailure">
          <Control ID="Sequence" name="MainControlLoop">
            <!--Poll the grip button state-->
            <Action ID="GetBoolInstance" bool_topic_name="/right_grip_button_state" subscribed_bool_instance="{grip_bool_msg}"/>
            <Action ID="UnpackBoolMessage" bool="{grip_bool_msg}" data="{current_grip}"/>
            <!--Rising edge detection: rising_edge = current AND NOT prev-->
            <Action ID="Script" code="rising_edge_detected := current_grip &amp;&amp; !prev_grip"/>
            <!--On rising edge: snap to end effector pose (clutch-in behavior)-->
            <Decorator ID="Precondition" else="SUCCESS" if="rising_edge_detected">
              <Control ID="Sequence" name="SnapToEndEffectorOnClutchIn">
                <Action ID="LogMessage" message="Clutch-in: Snapping target to end effector pose"/>
                <!--Enable tracking on first clutch press-->
                <Action ID="Script" code="tracking_enabled := true"/>
                <!--SNAP: Get current end effector pose and set it as the initial grasp pose-->
                <Action ID="CreateStampedPose" reference_frame="grasp_link" stamped_pose="{initial_grasp_pose}" name="Snap to current end effector pose"/>
                <Action ID="TransformPoseFrame" input_pose="{initial_grasp_pose}" output_pose="{initial_grasp_pose}" target_frame_id="world"/>
                <!--Set target_pose immediately to the snapped pose-->
                <Action ID="TransformPoseFrame" input_pose="{initial_grasp_pose}" output_pose="{target_pose}" target_frame_id="world"/>
                <Action ID="VisualizePose" pose="{initial_grasp_pose}" marker_name="initial grasp pose" marker_size="0.100000" marker_text="i_g"/>
                <!--Capture current controller pose as the new reference in WORLD frame-->
                <Action ID="GetOdomInstance" odom_topic_name="/right_controller_odom" subscribed_odom_instance="{odometry}" name="Capture controller pose at clutch-in"/>
                <Action ID="ConvertOdomToPoseStamped" pose_stamped="{initial_controller_pose}" odometry="{odometry}"/>
                <Action ID="TransformPoseFrame" input_pose="{initial_controller_pose}" output_pose="{initial_controller_pose}" target_frame_id="world"/>
                <Action ID="VisualizePose" pose="{initial_controller_pose}" marker_name="initial controller pose" marker_text="i_c"/>
              </Control>
            </Decorator>
            <!--Compute target pose when grip is held (not on rising edge, already handled)-->
            <Decorator ID="Precondition" else="SUCCESS" if="current_grip &amp;&amp; !rising_edge_detected">
              <Control ID="Sequence" name="ComputeTargetWhenClutchHeld">
                <!--Get current controller pose in WORLD frame-->
                <Action ID="GetOdomInstance" odom_topic_name="/right_controller_odom" subscribed_odom_instance="{odometry}"/>
                <Action ID="ConvertOdomToPoseStamped" pose_stamped="{controller_pose}" odometry="{odometry}"/>
                <Action ID="TransformPoseFrame" input_pose="{controller_pose}" output_pose="{controller_pose}" target_frame_id="world"/>
                <!--Calculate offset from initial to current controller pose (BOTH in world frame now)-->
                <Action ID="CalculatePoseOffset" destination_pose="{controller_pose}" source_pose="{initial_controller_pose}" source_to_destination_pose="{pose_delta}"/>
                <!--Apply the delta transform to the initial grasp pose (ALL in world frame now)-->
                <Action ID="TransformPoseWithPose" transform_pose="{pose_delta}" input_pose="{initial_grasp_pose}" output_pose="{target_pose}"/>
                <Action ID="VisualizePose" pose="{target_pose}" marker_text="target" marker_size="0.1" marker_name="target"/>
                <Action ID="VisualizePose" pose="{controller_pose}" marker_name="controller" marker_text="controller"/>
              </Control>
            </Decorator>
            <!--Only track target_pose AFTER first clutch press (tracking_enabled = true)-->
            <Decorator ID="Precondition" else="SUCCESS" if="tracking_enabled">
              <Control ID="Sequence" name="ComputeVelocityToTrackTarget">
                <Action ID="ConvertPoseStampedToOdom" odom="{target_odom}" pose_stamped="{target_pose}"/>
                <Action ID="CreateStampedPose" stamped_pose="{target_pose_offset}"/>
                <Action ID="ComputeVelocityToAlignWithTarget" target_motion_state="{target_odom}" target_pose_offset="{target_pose_offset}" output_control_velocity="{stamped_twist}" proportional_gain_angular=".5" proportional_gain_linear=".4"/>
                <Action ID="CreateStampedWrench" reference_frame="grasp_link"/>
              </Control>
            </Decorator>
            <!--Update prev_grip for next iteration's edge detection-->
            <Action ID="Script" code="prev_grip := current_grip"/>
          </Control>
        </Decorator>
        <!--Branch 2: Continuously publish velocity commands-->
        <Action ID="PublishVelocityForceCommand" twist_stamped="{stamped_twist}" wrench_stamped="{stamped_wrench}" velocity_controlled_axes="1;1;1;1;1;1" publish_rate="10"/>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Teleop With Meta via Pose v6">
      <MetadataFields>
        <Metadata runnable="true"/>
        <Metadata subcategory="User Input"/>
      </MetadataFields>
    </SubTree>
  </TreeNodesModel>
</root>
