<?xml version="1.0" encoding="utf-8" ?>
<root
  BTCPP_format="4"
  main_tree_to_execute="Constrained Pick and Place Subtree"
>
  <!--//////////-->
  <BehaviorTree
    ID="Constrained Pick and Place Subtree"
    _subtreeOnly="true"
    _description=""
  >
    <Control ID="Sequence">
      <!--Create a special type of motion planning configuration that includes an upwards orientation requirement-->
      <Action
        ID="InitializeMotionConstraints"
        constraints_name="gripper pointing down"
        constraints="{constraints}"
      />
      <Action
        ID="AppendOrientationConstraint"
        config_file_name="my_constraints.yaml"
        constraints="{constraints}"
      />
      <!--Move to pick location-->
      <!--Note: Sampling based planners can be non-deterministic. The retry decorator improves the likelihood of success-->
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          waypoint_name="{pre_pick}"
          joint_group_name="manipulator"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          planner_interface="moveit_default"
          constraints="{constraints}"
        />
      </Decorator>
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          waypoint_name="{pick}"
          joint_group_name="manipulator"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          planner_interface="moveit_default"
          constraints="{constraints}"
        />
      </Decorator>
      <!--We force success as the gripper closes, since we are commanding a position it will never reach (fingers fully closed)-->
      <Decorator ID="ForceSuccess">
        <SubTree ID="Close Gripper" />
      </Decorator>
      <!--Move to place (drop) location-->
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          joint_group_name="manipulator"
          planner_interface="moveit_default"
          constraints="{constraints}"
          _collapsed="true"
          waypoint_name="{pre_pick}"
        />
      </Decorator>
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          joint_group_name="manipulator"
          planner_interface="moveit_default"
          constraints="{constraints}"
          _collapsed="true"
          waypoint_name="{pre_place}"
        />
      </Decorator>
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          joint_group_name="manipulator"
          planner_interface="moveit_default"
          constraints="{constraints}"
          _collapsed="true"
          waypoint_name="{place}"
        />
      </Decorator>
      <SubTree ID="Open Gripper" />
      <Decorator ID="RetryUntilSuccessful" num_attempts="3">
        <SubTree
          ID="Move to Waypoint"
          controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
          joint_group_name="manipulator"
          planner_interface="moveit_default"
          constraints="{constraints}"
          _collapsed="true"
          waypoint_name="{pre_place}"
        />
      </Decorator>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Constrained Pick and Place Subtree">
      <inout_port name="pre_pick" default="" />
      <inout_port name="pick" default="" />
      <inout_port name="pre_place" default="" />
      <inout_port name="place" default="" />
    </SubTree>
  </TreeNodesModel>
</root>
