<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Teleop With Meta via Pose v10">
  <BehaviorTree
    ID="Teleop With Meta via Pose v10"
    _description=""
    _favorite="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <SubTree
        ID="Open Gripper"
        _collapsed="true"
        name="Start with knowledge of the gripper state"
      />
      <Action ID="Script" code="gripper_open := true" />
      <Action
        ID="SwitchController"
        activate_controllers="velocity_force_controller"
        name="Switch to VFC"
        automatic_deactivation="true"
      />
      <Control
        ID="Parallel"
        failure_count="1"
        success_count="3"
        name="This should only fail due to an error induced Failure"
      >
        <!--This should be an endless loop of publishing start of demonstration indicators, stop of demonstration indicators, and running instances of "clutched" teleoperation.-->
        <Control ID="Sequence" name="Check for start of demonstration">
          <Action
            ID="GetEmpty"
            empty_topic_name="/right_primary_button_event"
            message_count="{message_count}"
          />
          <Action ID="LogMessage" message="Starting demonstration" />
          <Action
            ID="PublishString"
            message="Starting demonstration"
            topic="/demonstration_indicator"
            use_best_effort="false"
          />
        </Control>
        <Control ID="Sequence" name="Check for stop of demosntration">
          <Action
            ID="GetEmpty"
            empty_topic_name="/right_secondary_button_event"
            message_count="{message_count}"
          />
          <Action ID="LogMessage" message="Stopping demonstration" />
          <Action
            ID="PublishString"
            message="Stopping demonstration"
            topic="/demonstration_indicator"
          />
        </Control>
        <Decorator
          ID="KeepRunningUntilFailure"
          name="Teleoperation loop (instances of &quot;clutching&quot; in)"
        >
          <Control ID="Sequence" name="">
            <Control ID="Sequence" name="Set up initial zero twist command">
              <Action ID="CreateStampedWrench" />
              <Action ID="CreateStampedTwist" reference_frame="world" />
            </Control>
            <Control ID="Sequence" name="Block on grip event">
              <Action
                ID="GetEmpty"
                empty_topic_name="/right_grip_button_event"
                name=""
              />
              <Action ID="LogMessage" message="grip event" />
            </Control>
            <Control
              ID="Sequence"
              name="Store gripper and controller poses at grip time"
            >
              <Action
                ID="CreateStampedPose"
                stamped_pose="{initial_grasp_pose}"
                name="Store initial pose of grasp_link upon grip event"
                reference_frame="grasp_link"
                orientation_xyzw="0;0;0;1"
              />
              <Action
                ID="TransformPoseFrame"
                input_pose="{initial_grasp_pose}"
                output_pose="{initial_grasp_pose}"
                target_frame_id="world"
              />
              <Action
                ID="VisualizePose"
                pose="{initial_grasp_pose}"
                marker_name="initial grasp pose"
                marker_size="0.100000"
                marker_text="i_g"
              />
              <Action
                ID="GetOdomInstance"
                odom_topic_name="/right_controller_odom"
                subscribed_odom_instance="{odometry}"
                name="Store initial pose of controller upon grip event"
              />
              <Action
                ID="ConvertOdomToPoseStamped"
                pose_stamped="{initial_controller_pose}"
                odometry="{odometry}"
              />
              <Action
                ID="VisualizePose"
                pose="{initial_controller_pose}"
                marker_name="initial controller pose"
                marker_text="i_c"
              />
              <Action
                ID="TransformPoseFrame"
                input_pose="{initial_controller_pose}"
                output_pose="{initial_controller_pose}"
                target_frame_id="quest"
              />
            </Control>
            <Control
              ID="Parallel"
              failure_count="1"
              success_count="1"
              name="Jog to target pose until grip release, then return Success"
            >
              <Decorator ID="KeepRunningUntilFailure" name="Update wrench">
                <Control
                  ID="Sequence"
                  name="Compute the pose offset from initial_controller to current_controller and apply it to initial_grasp"
                >
                  <Action
                    ID="GetOdomInstance"
                    odom_topic_name="/right_controller_odom"
                    subscribed_odom_instance="{odometry}"
                  />
                  <Action
                    ID="ConvertOdomToPoseStamped"
                    pose_stamped="{controller_pose}"
                    odometry="{odometry}"
                  />
                  <Action
                    ID="CalculatePoseOffset"
                    destination_pose="{controller_pose}"
                    source_pose="{initial_controller_pose}"
                    source_to_destination_pose="{pose_transform}"
                  />
                  <SubTree
                    ID="ConvertPoseStampedToVectors"
                    _collapsed="false"
                    pose_stamped="{pose_transform}"
                    name="Compute start controller to current controller transform"
                  />
                  <Action
                    ID="TransformPose"
                    quaternion_xyzw="{vec_quaternion}"
                    translation_xyz="{vec_position}"
                    input_pose="{initial_grasp_pose}"
                    output_pose="{target_pose}"
                    name="Update target pose via controller transform"
                  />
                  <Action
                    ID="VisualizePose"
                    pose="{target_pose}"
                    marker_text="target"
                    marker_size="0.1"
                    marker_name="target"
                  />
                  <Action
                    ID="VisualizePose"
                    pose="{controller_pose}"
                    marker_name="controller"
                    marker_text="controller"
                  />
                  <Control
                    ID="Sequence"
                    name="Update wrench with updated target pose"
                  >
                    <Action
                      ID="ConvertPoseStampedToOdom"
                      odom="{target_odom}"
                      pose_stamped="{target_pose}"
                      child_frame="child_frame"
                    />
                    <Action
                      ID="CreateStampedPose"
                      stamped_pose="{target_pose_offset}"
                    />
                    <Action
                      ID="ComputeVelocityToAlignWithTarget"
                      target_motion_state="{target_odom}"
                      target_pose_offset="{target_pose_offset}"
                      output_control_velocity="{stamped_twist}"
                      proportional_gain_angular=".5"
                      proportional_gain_linear=".4"
                    />
                    <Action
                      ID="CreateStampedWrench"
                      reference_frame="grasp_link"
                    />
                  </Control>
                </Control>
              </Decorator>
              <Action
                ID="PublishVelocityForceCommand"
                twist_stamped="{stamped_twist}"
                wrench_stamped="{stamped_wrench}"
                velocity_controlled_axes="1;1;1;1;1;1"
                publish_rate="10"
                wrench_gain="0.0"
                name="Publish updated wrench"
              />
              <Decorator
                ID="KeepRunningUntilFailure"
                name="Check for trigger event for gripper"
              >
                <Action
                  ID="GetEmpty"
                  empty_topic_name="/right_trigger_button_event"
                  message_count="{message_count}"
                />
                <Control ID="IfThenElse">
                  <Decorator
                    ID="Precondition"
                    else="FAILURE"
                    if="gripper_open"
                    name="Is gripper open"
                  >
                    <Action ID="AlwaysSuccess" />
                  </Decorator>
                  <Control ID="Sequence" name="Yes -&gt; Close gripper">
                    <SubTree ID="Close Gripper" _collapsed="true" />
                    <Action ID="Script" code="gripper_open := false" />
                  </Control>
                  <Control ID="Sequence" name="No -&gt; Open gripper">
                    <SubTree ID="Open Gripper" _collapsed="true" />
                    <Action ID="Script" code="gripper_open := true" />
                  </Control>
                </Control>
              </Decorator>
              <Decorator
                ID="Inverter"
                name="KeepRunningUntilSuccess (return Success on grip release)"
              >
                <Decorator ID="KeepRunningUntilFailure">
                  <Control ID="Sequence" name="Return true on grip release">
                    <Action
                      ID="GetBoolInstance"
                      bool_topic_name="/right_grip_button_state"
                      subscribed_bool_instance="{subscribed_bool_instance}"
                    />
                    <Decorator ID="Precondition" if="subscribed_bool_instance">
                      <Action ID="AlwaysSuccess" />
                    </Decorator>
                  </Control>
                </Decorator>
              </Decorator>
            </Control>
          </Control>
        </Decorator>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Teleop With Meta via Pose v10" />
  </TreeNodesModel>
</root>
