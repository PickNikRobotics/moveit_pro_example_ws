# Mobile base localization configuration using fuse
# Ground vehicle state estimation: wheel odometry + IMU
state_estimator:
  ros__parameters:
    # Fixed-lag smoother configuration
    optimization_frequency: 20.0
    transaction_timeout: 0.01
    lag_duration: 0.5

    # Motion model for mobile base (3D omnidirectional)
    motion_models:
      mobile_base_motion:
        type: fuse_models::Omnidirectional3D

    mobile_base_motion:
      # Process noise for state variables
      # Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
      # Ground robot: z, roll, pitch (and their velocities) should be small
      # since the robot stays on the ground plane and level.
      #trying this with the actual wheel odom 
      process_noise_diagonal: [0.25, 0.25, 0.001, 0.001, 0.001, 0.25, 0.1, 0.1, 0.001, 0.001, 0.001, 0.1, 0.001, 0.001, 0.001] 
      #this one works with the ground truth odom 
      #process_noise_diagonal: [2.0, 2.0, 0.1, 0.1, 0.1, 2.0, 2.0, 1.0, 0.1, 0.1, 0.1, 0.001, 0.01, 0.01, 0.001]

    sensor_models:
      initial_localization_sensor:
        type: fuse_models::Omnidirectional3DIgnition
        motion_models: [mobile_base_motion]
        ignition: true
      wheel_odom_sensor:
        type: fuse_models::Odometry3D
        motion_models: [mobile_base_motion]
      imu_sensor:
        type: fuse_models::Imu3D
        motion_models: [mobile_base_motion]

    initial_localization_sensor:
      publish_on_startup: true
      # Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
      initial_state: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
      initial_sigma: [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1]

    # Wheel odometry â€” differential mode
    # Using differential mode because platform_velocity_controller/odom is
    # wheel-integrated odometry that drifts over time. Differential mode fuses
    # only the relative change between consecutive messages, preventing
    # accumulated drift from corrupting the estimate.
    wheel_odom_sensor:
      topic: /platform_velocity_controller/odom
      queue_size: 10
      pose_loss:
        type: fuse_loss::HuberLoss
        a: 1.0
      linear_velocity_loss:
        type: fuse_loss::HuberLoss
        a: 1.0
      position_dimensions: ['x', 'y', 'z']
      orientation_dimensions: ['yaw']
      linear_velocity_dimensions: ['x']
      angular_velocity_dimensions: ['yaw']
      differential: true
      independent: false
      use_twist_covariance: true

    # IMU sensor
    # - Roll/pitch orientation from gravity vector (absolute, keeps robot level)
    # - Yaw angular velocity from gyroscope
    # - Z linear acceleration (gravity-compensated, constrains vertical dynamics)
    imu_sensor:
      topic: /imu_sensor_broadcaster/imu
      orientation_dimensions: ['roll', 'pitch']
      angular_velocity_dimensions: ['yaw']
      linear_acceleration_dimensions: ['z']
      remove_gravitational_acceleration: true
      queue_size: 10
      throttle_period: 0.1

    # Publish filtered odometry
    publishers:
      filtered_publisher:
        type: fuse_models::Odometry3DPublisher

    filtered_publisher:
      topic: 'odom_filtered'
      base_link_frame_id: 'ridgeback_base_link'
      base_link_output_frame_id: 'ridgeback_base_link'
      odom_frame_id: 'odom'
      map_frame_id: 'map'
      world_frame_id: 'odom'
      publish_tf: true
      publish_frequency: 10.0
      predict_to_current_time: true
