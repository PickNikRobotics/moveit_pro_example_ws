<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Order Poses">
  <BehaviorTree
    ID="Order Poses"
    _description="Orders poses for the Count Boxes Objective"
    _favorite="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <Action ID="CreateFloat64Message" data="{x_extent}" float64="{x_msg}" />
      <Action ID="UnpackFloat64Message" data="{x_extent}" float64="{x_msg}" />
      <Action ID="CreateFloat64Message" data="{y_extent}" float64="{y_msg}" />
      <Action ID="UnpackFloat64Message" data="{y_extent}" float64="{y_msg}" />
      <Action ID="Script" code="poses_ordered:=poses_in" />
      <Control ID="Sequence">
        <Action
          ID="UnpackPoseStampedMessage"
          header="{header}"
          pose="{pose}"
          pose_stamped="{centroid}"
        />
        <Action
          ID="UnpackPoseMessage"
          orientation="{orientation}"
          pose="{pose}"
          position="{position}"
        />
        <Action
          ID="UnpackPointMessage"
          point="{position}"
          x="{x}"
          y="{y}"
          z="{z}"
        />
        <Action ID="Script" code="left:=x-(x_extent/2)" />
        <Action ID="Script" code="right:=x+(x_extent/2)" />
        <Action ID="Script" code="top:=y+(y_extent/2)" />
        <Action ID="Script" code="bottom:=y-(y_extent/2)" />
        <Control ID="Sequence">
          <Action
            ID="CreatePointMessage"
            point="{bottom_left}"
            x="{left}"
            y="{bottom}"
            z="{z}"
          />
          <Action
            ID="CreatePoseMessage"
            orientation="{orientation}"
            pose="{pose_bottom_left}"
            position="{bottom_left}"
          />
          <Action
            ID="CreatePoseStampedMessage"
            header="{header}"
            pose="{pose_bottom_left}"
            pose_stamped="{pose_stamped_bottom_left}"
          />
        </Control>
        <Control ID="Sequence">
          <Action
            ID="CreatePointMessage"
            point="{top_left}"
            x="{left}"
            y="{top}"
            z="{z}"
          />
          <Action
            ID="CreatePoseMessage"
            orientation="{orientation}"
            pose="{pose_top_left}"
            position="{top_left}"
          />
          <Action
            ID="CreatePoseStampedMessage"
            header="{header}"
            pose="{pose_top_left}"
            pose_stamped="{pose_stamped_top_left}"
          />
        </Control>
        <Control ID="Sequence">
          <Action
            ID="CreatePointMessage"
            point="{top_right}"
            x="{right}"
            y="{top}"
            z="{z}"
          />
          <Action
            ID="CreatePoseMessage"
            orientation="{orientation}"
            pose="{pose_top_right}"
            position="{top_right}"
          />
          <Action
            ID="CreatePoseStampedMessage"
            header="{header}"
            pose="{pose_top_right}"
            pose_stamped="{pose_stamped_top_right}"
          />
        </Control>
        <Control ID="Sequence">
          <Action
            ID="CreatePointMessage"
            point="{bottom_right}"
            x="{right}"
            y="{bottom}"
            z="{z}"
          />
          <Action
            ID="CreatePoseMessage"
            orientation="{orientation}"
            pose="{pose_bottom_right}"
            position="{bottom_right}"
          />
          <Action
            ID="CreatePoseStampedMessage"
            header="{header}"
            pose="{pose_bottom_right}"
            pose_stamped="{pose_stamped_bottom_right}"
          />
        </Control>
      </Control>
      <Control ID="Sequence">
        <Decorator
          ID="ForEach"
          index="{index}"
          out="{out}"
          vector_in="{poses_in}"
        >
          <Control ID="Fallback">
            <Decorator ID="Precondition" else="FAILURE" if="index == 0">
              <Control ID="Sequence">
                <SubTree
                  ID="Find Nearest Pose In Path"
                  _collapsed="true"
                  nearest_index="{nearest_index}"
                  nearest_pose="{nearest_pose}"
                  pose_vector="{poses_in}"
                  search_pose="{pose_stamped_bottom_left}"
                />
                <Action
                  ID="ReplaceInVector"
                  index="{index}"
                  input_vector="{poses_ordered}"
                  output_vector="{poses_ordered}"
                  element="{nearest_pose}"
                />
              </Control>
            </Decorator>
            <Decorator ID="Precondition" else="FAILURE" if="index == 1">
              <Control ID="Sequence">
                <SubTree
                  ID="Find Nearest Pose In Path"
                  nearest_index="{nearest_index}"
                  nearest_pose="{nearest_pose}"
                  pose_vector="{poses_in}"
                  search_pose="{pose_stamped_top_left}"
                />
                <Action
                  ID="ReplaceInVector"
                  index="{index}"
                  input_vector="{poses_ordered}"
                  output_vector="{poses_ordered}"
                  element="{nearest_pose}"
                />
              </Control>
            </Decorator>
            <Decorator ID="Precondition" else="FAILURE" if="index == 2">
              <Control ID="Sequence">
                <SubTree
                  ID="Find Nearest Pose In Path"
                  nearest_index="{nearest_index}"
                  nearest_pose="{nearest_pose}"
                  pose_vector="{poses_in}"
                  search_pose="{pose_stamped_top_right}"
                />
                <Action
                  ID="ReplaceInVector"
                  index="{index}"
                  input_vector="{poses_ordered}"
                  output_vector="{poses_ordered}"
                  element="{nearest_pose}"
                />
              </Control>
            </Decorator>
            <Decorator ID="Precondition" else="FAILURE" if="index == 3">
              <Control ID="Sequence">
                <SubTree
                  ID="Find Nearest Pose In Path"
                  nearest_index="{nearest_index}"
                  nearest_pose="{nearest_pose}"
                  pose_vector="{poses_in}"
                  search_pose="{pose_stamped_bottom_right}"
                />
                <Action
                  ID="ReplaceInVector"
                  index="{index}"
                  input_vector="{poses_ordered}"
                  output_vector="{poses_ordered}"
                  element="{nearest_pose}"
                />
              </Control>
            </Decorator>
            <Decorator ID="ForceFailure">
              <Action
                ID="LogMessage"
                log_level="error"
                message="This shouldn't get over here"
              />
            </Decorator>
          </Control>
        </Decorator>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Order Poses">
      <MetadataFields>
        <Metadata runnable="false" />
        <Metadata subcategory="Motion - Planning" />
      </MetadataFields>
      <inout_port
        name="centroid"
        default="{centroid}"
        type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"
      />
      <inout_port name="poses_in" default="{poses_in}" />
      <inout_port name="poses_ordered" default="{poses_ordered}" />
      <inout_port name="x_extent" default="{x_extent}" />
      <inout_port name="y_extent" default="{y_extent}" />
    </SubTree>
  </TreeNodesModel>
</root>
