<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Count Boxes Objective">
  <BehaviorTree
    ID="Count Boxes Objective"
    _description="Count the number of boxes in a given area."
    _favorite="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <SubTree
        ID="CreatePoseVectorFromDirectory"
        _collapsed="false"
        pose_vector="{pose_vector}"
        directory_path="{pose_path}"
        name="given a path, load a PoseStamped from each yaml in that directory"
      />
      <!--Crop outliers from our region of interest-->
      <Action
        ID="CreateStampedPose"
        reference_frame="world"
        stamped_pose="{crop_pose_centroid}"
        position_xyz="-11;2.75;0"
      />
      <Action
        ID="VisualizePath"
        marker_lifetime="0.000000"
        marker_name="path_initial"
        path="{pose_vector}"
        pose_marker_size="1"
        show_poses="true"
      />
      <Action
        ID="CropPosesInBox"
        crop_box_centroid_pose="{crop_pose_centroid}"
        poses="{pose_vector}"
        poses_cropped="{path_cropped}"
        crop_box_size="12;12;1"
      />
      <SubTree
        ID="Order Poses"
        _collapsed="false"
        centroid="{crop_pose_centroid}"
        poses_in="{path_cropped}"
        poses_ordered="{poses_ordered}"
        x_extent="12"
        y_extent="12"
      />
      <Action
        ID="VisualizePath"
        marker_lifetime="0.000000"
        marker_name="poses_ordered"
        path="{poses_ordered}"
        pose_marker_size="1"
        show_poses="true"
      />
      <Action
        ID="SwitchController"
        activate_asap="true"
        automatic_deactivation="true"
        controller_list_action_name="/controller_manager/list_controllers"
        controller_switch_action_name="/controller_manager/switch_controller"
        strictness="1"
        timeout="-1.000000"
        activate_controllers="platform_velocity_controller_nav2"
        deactivate_controllers="platform_velocity_controller"
      />
      <Action ID="Script" code="total_box_count:=0" />
      <!--Drive through our newly ordered list of poses and count boxes at each Pose-->
      <Decorator
        ID="ForEach"
        index="{index}"
        out="{out}"
        vector_in="{poses_ordered}"
      >
        <Control ID="Sequence">
          <Action
            ID="NavigateToPoseAction"
            action_name="/navigate_to_pose"
            current_pose="{current_pose}"
            distance_remaining="{distance_remaining}"
            estimated_time_remaining="{estimated_time_remaining}"
            ignore_stamp_time="true"
            navigation_time="{navigation_time}"
            number_of_recoveries="{number_of_recoveries}"
            pose_stamped="{out}"
            timeout_sec="-1.000000"
            behavior_tree_path="/opt/ros/humble/share/nav2_bt_navigator/behavior_trees/navigate_to_pose_w_replanning_and_recovery.xml"
          />
          <SubTree
            ID="Count boxes subtree"
            _collapsed="false"
            box_count="{box_count}"
            scene_camera_folder="{scene_camera_folder}"
            wrist_camera_folder="{wrist_camera_folder}"
          />
          <Action ID="Script" code="total_box_count+=box_count" />
        </Control>
      </Decorator>
      <Action ID="LogMessage" log_level="info" message="{total_box_count}" />
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Count Boxes Objective">
      <MetadataFields>
        <Metadata runnable="false" />
        <Metadata subcategory="Application - Advanced Examples" />
      </MetadataFields>
      <inout_port
        name="wrist_camera_folder"
        default="/home/studio-user/user_ws/src/hangar_sim/wrist_camera_images"
        type="std::string"
      >
        Absolute path to a directory for saving wrist camera pictures
      </inout_port>
      <inout_port
        name="scene_camera_folder"
        default="/home/studio-user/user_ws/src/hangar_sim/scene_camera_images"
        type="std::string"
      >
        Absolute path to a directory for saving scene camera pictures
      </inout_port>
      <inout_port
        name="pose_path"
        default="/home/studio-user/user_ws/src/hangar_sim/poses"
        type="std::string"
      >
        Absolute path to a directory of pose YAML files
      </inout_port>
    </SubTree>
  </TreeNodesModel>
</root>
