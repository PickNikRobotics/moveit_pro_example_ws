<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Track Moving Frame">
  <!--//////////-->
  <BehaviorTree ID="Track Moving Frame" _description="Moves a given end-effector link to track a moving frame, e.g. to control the robot arm with a teleoperation device." _favorite="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <Action ID="CreateStampedWrench" reference_frame="world" stamped_wrench="{stamped_wrench}"/>
      <Action ID="SwitchController" activate_asap="true" automatic_deactivation="true" controller_list_action_name="/controller_manager/list_controllers" controller_switch_action_name="/controller_manager/switch_controller" strictness="1" timeout="1000.0" activate_controllers="{velocity_force_controller_name}"/>
      <Action ID="CreateStampedPose" reference_frame="{default_ik_frame}" stamped_pose="{target_pose_offset}"/>
      <Control ID="Parallel" success_count="3" failure_count="1">
        <Decorator ID="KeepRunningUntilFailure">
          <Action ID="VisualizePose" marker_lifetime="0.000000" marker_name="pose" marker_size="0.100000" pose="{target_pose}"/>
        </Decorator>
        <Decorator ID="Delay" delay_msec="100">
          <Decorator ID="KeepRunningUntilFailure">
            <Control ID="Sequence">
              <Action ID="ComputeVelocityToAlignWithTarget" end_effector_frame="{default_ik_frame}" output_control_velocity="{control_velocity}" output_pose_error="{pose_error}" proportional_gain_linear="{proportional_gain_linear}" target_motion_state="{target_motion_state}" target_pose_offset="{target_pose_offset}" proportional_gain_angular="{proportional_gain_angular}"/>
            </Control>
          </Decorator>
        </Decorator>
        <Decorator ID="Delay" delay_msec="100">
          <Decorator ID="KeepRunningUntilFailure">
            <Action ID="PublishVelocityForceCommand" force_controlled_axes="0;0;0;0;0;0" publish_rate="10" twist_stamped="{control_velocity}" velocity_controlled_axes="1;1;1;1;1;1" velocity_force_controller_command_topic="{velocity_force_controller_command_topic}" wrench_gain="0.0" wrench_stamped="{stamped_wrench}"/>
          </Decorator>
        </Decorator>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Track Moving Frame">
      <MetadataFields>
        <Metadata subcategory="Motion - Execute"/>
        <Metadata runnable="false"/>
      </MetadataFields>
      <input_port name="default_ik_frame" default="grasp_link" description="The frame to use for the inverse kinematics calculations."/>
      <input_port name="target_motion_state" default="{target_motion_state}" description="The target odometry message containing pose and velocity information."/>
      <input_port name="target_pose" default="{target_pose}" description="The target pose for visualization."/>
      <input_port name="proportional_gain_angular" default="2.0" description="The proportional gain for angular velocity control."/>
      <input_port name="proportional_gain_linear" default="2.0" description="The proportional gain for linear velocity control."/>
      <input_port name="velocity_force_controller_command_topic" default="/velocity_force_controller/command" description="The topic to publish velocity force commands."/>
      <input_port name="velocity_force_controller_name" default="velocity_force_controller" description="The name of the velocity force controller."/>
    </SubTree>
  </TreeNodesModel>
</root>
