<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Pick Brackets from Left Bin">
  <!--//////////-->
  <BehaviorTree
    ID="Pick Brackets from Left Bin"
    _description="Picks brackets from the left bin, and drops them in the right bin."
    _favorite="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <!--Prepare the planning scene-->
      <Action ID="ClearSnapshot" />
      <SubTree ID="Reset Planning Scene" _collapsed="true" />
      <SubTree ID="Setup Initial Planning Scene" _collapsed="true" />
      <SubTree ID="Add Bins to Planning Scene" _collapsed="true" />
      <!--Pickup vacuum gripper-->
      <SubTree ID="Automated Return Held Tool" _collapsed="true" />
      <SubTree
        ID="Automated Tool Changing Example Subtree"
        _collapsed="true"
        pickup_tool="suction_gripper"
        tool_1_name="suction_gripper"
        tool_1_pickup_site="suction_gripper_attach_site"
        tool_1_return_site="suction_gripper_holder_site"
        tool_2_name="inspector"
        tool_2_pickup_site="inspection_tool_attach_site"
        tool_2_return_site="inspection_tool_holder_site"
        tool_names="suction_gripper;inspector"
      />
      <Decorator
        ID="Repeat"
        num_cycles="3"
        name="Pick a fixed number of brackets"
      >
        <Control ID="Sequence">
          <Control
            ID="Sequence"
            name="Look for the bracket part in the left bin and register it to the CAD of the part. Return the registered pose of the part for picking."
          >
            <!--Get the bracket pointcloud from the CAD file and make a guess as to where it might be-->
            <Action ID="ClearSnapshot" />
            <Action
              ID="CreateStampedPose"
              position_xyz="-0.35;0.8;0.4"
              orientation_xyzw="0.000;0.000;0.0;1"
              name="Initial guess for bracket pose, somewhere above left bin"
              stamped_pose="{guess_pose}"
              reference_frame="world"
            />
            <SubTree
              ID="Load Bracket Part Pointcloud Subtree"
              _collapsed="true"
              color="0;0;255"
              initial_pose="{guess_pose}"
              bracket_part_cloud="{blue_bracket_part_cloud}"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="guess_pose"
              marker_size="0.100000"
              pose="{guess_pose}"
              marker_text="initial bracket pose estimate"
            />
            <Action
              ID="SendPointCloudToUI"
              point_cloud="{blue_bracket_part_cloud}"
              pcd_topic="/pcd_pointcloud_captures"
              name="Visualize initial bracket pose guess"
            />
            <!--Capture points of the left bin and crop out the bin to make it easier for ICP to match. Here is where another method of masking out non bracket points would happen-->
            <Action
              ID="GetPointCloud"
              topic_name="/bin_camera_left/points"
              message_out="{bin_camera_left_cloud}"
              message_timeout_sec="5.000000"
              publisher_timeout_sec="5.000000"
              name="Capture left bin points"
            />
            <Action
              ID="TransformPointCloudFrame"
              input_cloud="{bin_camera_left_cloud}"
              output_cloud="{bin_camera_left_cloud}"
              target_frame="world"
            />
            <Control
              ID="Sequence"
              name="Crop out points belonging to the bin by making a box that approximates the bin internal volume"
            >
              <Action
                ID="CreateStampedPose"
                reference_frame="world"
                stamped_pose="{centroid_pose}"
                position_xyz="-0.25;0.6;0.4"
              />
              <Action
                ID="CropPointsInBox"
                crop_box_centroid_pose="{centroid_pose}"
                point_cloud="{bin_camera_left_cloud}"
                point_cloud_cropped="{cropped_bin_point_cloud}"
                crop_box_size="0.32;0.55;0.28"
              />
            </Control>
            <Action
              ID="RegisterPointClouds"
              target_point_cloud="{cropped_bin_point_cloud}"
              base_point_cloud="{blue_bracket_part_cloud}"
              max_iterations="100"
              target_pose_in_base_frame="{registered_to_guess_pose}"
              max_correspondence_distance="0.5"
              name="Produce updated pose, relative to the initial guess pose"
            />
            <Action
              ID="TransformPoseWithPose"
              input_pose="{guess_pose}"
              transform_pose="{registered_to_guess_pose}"
              output_pose="{registered_pose}"
              name="Because the pose produced by point cloud registration is relative to the guess pose, we need to add that on to get to the real pose in world frame"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="registered_pose"
              marker_size="0.100000"
              pose="{registered_pose}"
              marker_text="registered bracket pose"
            />
            <Control
              ID="Sequence"
              name="Visualize the registered bracket point cloud in scene"
            >
              <SubTree
                ID="Load Bracket Part Pointcloud Subtree"
                _collapsed="true"
                color="0;255;0"
                initial_pose="{registered_pose}"
                bracket_part_cloud="{green_bracket_part_cloud}"
              />
              <Action
                ID="SendPointCloudToUI"
                point_cloud="{green_bracket_part_cloud}"
                pcd_topic="/pcd_pointcloud_captures"
              />
            </Control>
          </Control>
          <SubTree
            ID="Vacuum Pick Bracket Part Subtree"
            _collapsed="true"
            bracket_part_pose="{registered_pose}"
            part_name="single_bracket_part"
          />
          <SubTree ID="Vacuum Drop Bracket Part Subtree" _collapsed="true" />
        </Control>
      </Decorator>
      <!--Stow vacuum gripper-->
      <SubTree ID="Automated Return Held Tool" _collapsed="true" />
      <SubTree
        ID="Move to Waypoint"
        _collapsed="true"
        acceleration_scale_factor="1.0"
        controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
        controller_names="joint_trajectory_controller"
        joint_group_name="manipulator"
        keep_orientation="false"
        keep_orientation_tolerance="0.05"
        link_padding="0.01"
        seed="0"
        velocity_scale_factor="1.0"
        waypoint_name="Home"
      />
      <!--Cleanup planning scene-->
      <Action ID="ClearSnapshot" />
      <SubTree ID="Reset Planning Scene" collapsed="true" _collapsed="true" />
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Pick Brackets from Left Bin">
      <MetadataFields>
        <Metadata subcategory="Application - Advanced Examples" />
        <Metadata runnable="true" />
      </MetadataFields>
    </SubTree>
  </TreeNodesModel>
</root>
