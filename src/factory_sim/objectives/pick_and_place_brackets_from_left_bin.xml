<?xml version="1.0" encoding="UTF-8" ?>
<root
  BTCPP_format="4"
  main_tree_to_execute="Pick and Place Brackets from Left Bin"
>
  <BehaviorTree
    ID="Pick and Place Brackets from Left Bin"
    _description="Picks brackets from the left bin, precisely places them on jig, then picks them again and drop in right bin."
    _favorite="true"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <!--Prepare the planning scene-->
      <Action ID="ClearSnapshot" />
      <SubTree ID="Reset Planning Scene" _collapsed="true" />
      <SubTree ID="Setup Initial Planning Scene" _collapsed="true" />
      <SubTree ID="Add Bins to Planning Scene" _collapsed="true" />
      <SubTree ID="Visualize Bins and Jig" _collapsed="true" />
      <!--Adding the stack light jig indicator is just to simulate for the user as if something was being done to the part on the jig-->
      <SubTree ID="Indicate Jig Empty" _collapsed="true" />
      <!--Pickup vacuum gripper-->
      <SubTree ID="Automated Return Held Tool" _collapsed="true" />
      <SubTree
        ID="Automated Tool Changing Example Subtree"
        _collapsed="true"
        pickup_tool="suction_gripper"
        tool_1_name="suction_gripper"
        tool_1_pickup_site="suction_gripper_attach_site"
        tool_1_return_site="suction_gripper_holder_site"
        tool_2_name="inspector"
        tool_2_pickup_site="inspection_tool_attach_site"
        tool_2_return_site="inspection_tool_holder_site"
        tool_names="suction_gripper;inspector"
      />
      <Decorator
        ID="Repeat"
        num_cycles="3"
        name="Pick a fixed number of brackets"
      >
        <Control
          ID="Sequence"
          name="This is the main sequence of detecting and picking the bracket parts, putting them on the jig, and them putting them in the right bin"
        >
          <SubTree ID="Indicate Jig Empty" _collapsed="true" />
          <Control
            ID="Sequence"
            name="Look for the bracket part in the left bin and register it to the CAD of the part. Return the registered pose of the part for picking."
          >
            <!--Get the bracket pointcloud from the CAD file and make a guess as to where it might be-->
            <Action ID="ClearSnapshot" _skipIf="true" />
            <Action
              ID="CreateStampedPose"
              position_xyz="-0.35;0.8;0.4"
              orientation_xyzw="0.000;0.000;0.0;1"
              name="Initial guess for bracket pose, somewhere above left bin"
              stamped_pose="{guess_pose}"
              reference_frame="world"
            />
            <SubTree
              ID="Load Bracket Part Pointcloud Subtree"
              _collapsed="true"
              color="0;0;255"
              initial_pose="{guess_pose}"
              bracket_part_cloud="{blue_bracket_part_cloud}"
            />
            <!--Poses are published using a marker called `pose_of_interest` so that the next marker replaces it and gives the user a less noisy visual indicator of what the robot is planning to do-->
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="pose_of_interest"
              marker_size="0.100000"
              pose="{guess_pose}"
              marker_text="initial bracket pose estimate"
            />
            <Action
              ID="SendPointCloudToUI"
              point_cloud="{blue_bracket_part_cloud}"
              pcd_topic="/pcd_pointcloud_captures"
              name="Visualize initial bracket pose guess"
            />
            <!--Capture points of the left bin and crop out the bin to make it easier for ICP to match. Here is where another method of masking out non bracket points would happen-->
            <Action
              ID="GetPointCloud"
              topic_name="/bin_camera_left/points"
              message_out="{bin_camera_left_cloud}"
              timeout_sec="5.000000"
              publisher_timeout_sec="5.000000"
              name="Capture left bin points"
            />
            <Action
              ID="TransformPointCloudFrame"
              input_cloud="{bin_camera_left_cloud}"
              output_cloud="{bin_camera_left_cloud}"
              target_frame="world"
            />
            <Control
              ID="Sequence"
              name="Crop out points belonging to the bin by making a box that approximates the bin internal volume"
            >
              <Action
                ID="CreateStampedPose"
                reference_frame="world"
                stamped_pose="{centroid_pose}"
                position_xyz="-0.25;0.6;0.4"
              />
              <Action
                ID="CropPointsInBox"
                crop_box_centroid_pose="{centroid_pose}"
                point_cloud="{bin_camera_left_cloud}"
                point_cloud_cropped="{cropped_bin_point_cloud}"
                crop_box_size="0.32;0.55;0.28"
              />
            </Control>
            <Action
              ID="RegisterPointClouds"
              target_point_cloud="{cropped_bin_point_cloud}"
              base_point_cloud="{blue_bracket_part_cloud}"
              max_iterations="100"
              target_pose_in_base_frame="{registered_to_guess_pose}"
              max_correspondence_distance="0.5"
              name="Produce updated pose, relative to the initial guess pose"
            />
            <Action
              ID="TransformPoseWithPose"
              input_pose="{guess_pose}"
              transform_pose="{registered_to_guess_pose}"
              output_pose="{registered_pose}"
              name="Because the pose produced by point cloud registration is relative to the guess pose, we need to add that on to get to the real pose in world frame"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="pose_of_interest"
              marker_size="0.100000"
              pose="{registered_pose}"
              marker_text="registered bracket pose"
            />
            <Control
              ID="Sequence"
              name="Visualize the registered bracket point cloud in scene"
            >
              <SubTree
                ID="Load Bracket Part Pointcloud Subtree"
                _collapsed="true"
                color="0;255;0"
                initial_pose="{registered_pose}"
                bracket_part_cloud="{green_bracket_part_cloud}"
              />
              <Action ID="ResetVector" vector="{additional_clouds}" />
              <Action
                ID="AddPointCloudToVector"
                point_cloud="{green_bracket_part_cloud}"
                point_cloud_vector="{additional_clouds}"
              />
              <SubTree
                ID="Visualize Bins and Jig Subtree"
                _collapsed="true"
                additional_clouds="{additional_clouds}"
              />
            </Control>
          </Control>
          <SubTree
            ID="Vacuum Pick Bracket Part Subtree"
            _collapsed="true"
            bracket_part_pose="{registered_pose}"
          />
          <Control
            ID="Sequence"
            name="Drop bracket part on jig via an intermediate waypoint"
          >
            <!--The drop pose is just above two tapered posts representing a tooling jib that match alignment holes in the bracket part. The part is then released and settles onto those jig posts.-->
            <Action
              ID="CreateStampedPose"
              reference_frame="jig_post1"
              stamped_pose="{drop_pose}"
              orientation_xyzw="1.000; 0.000; 0.000; 0.000"
              position_xyz="0.012;-0.01;0.16"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="pose_of_interest"
              marker_size="0.100000"
              pose="{drop_pose}"
              marker_text="jig drop pose"
            />
            <Action
              ID="RetrieveWaypoint"
              joint_group_name="manipulator"
              waypoint_joint_state="{midpoint_move}"
              waypoint_name="Intermediate Jig Pose"
            />
            <Action
              ID="InitializeMTCTask"
              task="{mtc_task}"
              trajectory_monitoring="false"
              controller_names="joint_trajectory_controller"
              task_id="drop_task"
              timeout="-1.000000"
            />
            <Action ID="SetupMTCCurrentState" task="{mtc_task}" />
            <Action
              ID="SetupMTCIgnoreCollisionsBetweenObjects"
              allow_collision="false"
              task="{mtc_task}"
              object_names="single_bracket_part;virtual_bowl_barrier"
            />
            <!--The arm is moved to this intermediate waypoint to give a more predicable arm motion while avoiding the hanging bowls. Even with a collision object modeled the arm would still make large motions at times which influenced how well the part was aligned to the jig posts.-->
            <Action
              ID="SetupMTCPlanToJointState"
              acceleration_scale_factor="1"
              joint_state="{midpoint_move}"
              keep_orientation="false"
              keep_orientation_link_names="tool0"
              keep_orientation_tolerance="0.300000"
              link_padding="0.0100000"
              max_iterations="5000"
              planning_group_name="manipulator"
              seed="0"
              task="{mtc_task}"
              trajectory_sampling_rate="100"
              velocity_scale_factor="1.000000"
            />
            <Action
              ID="SetupMTCPlanToPose"
              acceleration_scale_factor="0.5"
              ik_frame="tool0"
              keep_orientation="false"
              keep_orientation_link_names="tool0"
              keep_orientation_tolerance="0.100000"
              link_padding="0.0100000"
              max_iterations="5000"
              monitored_stage="current state"
              planning_group_name="manipulator"
              target_pose="{drop_pose}"
              task="{mtc_task}"
              trajectory_sampling_rate="100"
              velocity_scale_factor="1.000000"
            />
            <Action
              ID="PlanMTCTask"
              solution="{mtc_solution}"
              task="{mtc_task}"
            />
            <Action
              ID="ExecuteMTCTask"
              goal_duration_tolerance="-1.000000"
              solution="{mtc_solution}"
            />
            <!--A short pause is added here because sometimes the robot arm was still moving a little when the part was released, leading to the part missing the jig alignment posts-->
            <Action ID="WaitForDuration" delay_duration="0.5" />
            <SubTree ID="Deactivate Vacuum" _collapsed="true" />
            <SubTree
              ID="Detach and Remove Tool"
              _collapsed="true"
              tool_name="single_bracket_part"
            />
          </Control>
          <!--This jig apparatus and waiting is here just to motivate the use case and explain why the arm moves to a waiting pose, instead of dropping the part on the jig and then picking it right back up again-->
          <SubTree
            ID="Move to Waypoint"
            _collapsed="true"
            acceleration_scale_factor="1.0"
            controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
            controller_names="joint_trajectory_controller"
            joint_group_name="manipulator"
            keep_orientation="false"
            keep_orientation_tolerance="0.05"
            link_padding="0.01"
            seed="0"
            velocity_scale_factor="1.0"
            waypoint_name="Home"
            name="Send arm to waiting pose"
          />
          <Action
            ID="LogMessage"
            log_level="info"
            message="Waiting for a few seconds to simulate a operation being done to the bracket"
          />
          <SubTree ID="Visualize Bins and Jig" _collapsed="true" />
          <SubTree ID="Indicate Jig Working" _collapsed="true" />
          <Action ID="WaitForDuration" delay_duration="2" />
          <SubTree ID="Indicate Part Ready" _collapsed="true" />
          <SubTree
            ID="Move to Waypoint"
            _collapsed="true"
            acceleration_scale_factor="1.0"
            controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
            controller_names="joint_trajectory_controller"
            joint_group_name="manipulator"
            keep_orientation="false"
            keep_orientation_tolerance="0.05"
            link_padding="0.01"
            seed="0"
            velocity_scale_factor="1.0"
            waypoint_name="Jig Approach Pose"
          />
          <Control ID="Sequence" name="Move to jig pick approach pose and pick">
            <SubTree ID="Activate Vacuum" _collapsed="true" />
            <Action
              ID="CreateStampedPose"
              reference_frame="world"
              stamped_pose="{bracket_on_jig}"
              orientation_xyzw="0.000; 0.000; 1.000; 0.000"
              position_xyz="-0.319; -0.483; 0.225"
            />
            <Action
              ID="InitializeMTCTask"
              controller_names="joint_trajectory_controller"
              task_id="jig_approach"
              task="{mtc_task}"
              trajectory_monitoring="false"
              timeout="-1.000000"
            />
            <Action ID="SetupMTCCurrentState" task="{mtc_task}" />
            <Action
              ID="SetupMTCIgnoreCollisionsBetweenObjects"
              allow_collision="true"
              task="{mtc_task}"
              object_names="link_5;link_6;suction_gripper"
            />
            <Action
              ID="SetupMTCMoveAlongFrameAxis"
              axis_frame="tool0"
              axis_z="1"
              max_distance="0.07"
              min_distance="0.07"
              hand_frame="tool0"
              acceleration_scale="0.5"
              axis_x="0.000000"
              axis_y="0.000000"
              ignore_environment_collisions="false"
              planning_group_name="manipulator"
              velocity_scale="0.5"
              task="{mtc_task}"
            />
            <Action
              ID="PlanMTCTask"
              task="{mtc_task}"
              solution="{mtc_solution}"
            />
            <Action
              ID="ExecuteMTCTask"
              goal_duration_tolerance="-1.000000"
              solution="{mtc_solution}"
            />
            <Action
              ID="AddURDF"
              urdf_name="single_bracket_part"
              urdf_pose="{bracket_on_jig}"
              package_name="factory_sim"
              urdf_file_path="description/simple_bracket_collision_geometry.urdf"
            />
            <Action
              ID="AttachURDF"
              urdf_name="single_bracket_part"
              allowed_collision_links="link_5;link_6"
              parent_link_name="tool0"
            />
          </Control>
          <Control ID="Sequence" name="Retract straight off of jig ">
            <Action
              ID="InitializeMTCTask"
              controller_names="joint_trajectory_controller"
              task_id="jig_retract"
              task="{mtc_task}"
              trajectory_monitoring="false"
              timeout="-1.000000"
            />
            <Action ID="SetupMTCCurrentState" task="{mtc_task}" />
            <Action
              ID="SetupMTCIgnoreCollisionsBetweenObjects"
              allow_collision="true"
              task="{mtc_task}"
              object_names="link_5;link_6;suction_gripper"
            />
            <Action
              ID="SetupMTCMoveAlongFrameAxis"
              axis_frame="tool0"
              axis_z="-1"
              max_distance="0.1"
              min_distance="0.1"
              hand_frame="tool0"
              acceleration_scale="0.5"
              axis_x="0.000000"
              axis_y="0.000000"
              ignore_environment_collisions="false"
              planning_group_name="manipulator"
              velocity_scale="0.5"
              task="{mtc_task}"
            />
            <Action
              ID="PlanMTCTask"
              task="{mtc_task}"
              solution="{mtc_solution}"
            />
            <Action
              ID="ExecuteMTCTask"
              goal_duration_tolerance="-1.000000"
              solution="{mtc_solution}"
            />
          </Control>
          <SubTree ID="Indicate Jig Empty" _collapsed="true" />
          <Control ID="Sequence" name="Move to the  right bin to drop">
            <!--The drop pose is at a 5 degree tilt so it doesn't drop straight into the bin or on top of another part. Simulator instabilities can cause parts to jump when dropped perfectly flat.-->
            <Action
              ID="CreateStampedPose"
              reference_frame="world"
              stamped_pose="{drop_pose}"
              orientation_xyzw="-0.706; -0.706; -0.031; -0.031"
              position_xyz="0.23;0.54;0.65"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="pose_of_interest"
              marker_size="0.100000"
              pose="{drop_pose}"
              marker_text="bin drop pose"
            />
            <Action
              ID="RetrieveWaypoint"
              joint_group_name="manipulator"
              waypoint_joint_state="{midpoint_move}"
              waypoint_name="Intermediate Jig Pose"
            />
            <Action
              ID="InitializeMTCTask"
              task="{mtc_task}"
              trajectory_monitoring="false"
              controller_names="joint_trajectory_controller"
              task_id="drop_task"
              timeout="-1.000000"
            />
            <Action ID="SetupMTCCurrentState" task="{mtc_task}" />
            <Action
              ID="SetupMTCIgnoreCollisionsBetweenObjects"
              allow_collision="true"
              task="{mtc_task}"
              object_names="link_5;link_6;suction_gripper"
            />
            <Action
              ID="SetupMTCPlanToJointState"
              acceleration_scale_factor="1"
              joint_state="{midpoint_move}"
              keep_orientation="false"
              keep_orientation_link_names="tool0"
              keep_orientation_tolerance="0.300000"
              link_padding="0.0100000"
              max_iterations="5000"
              planning_group_name="manipulator"
              seed="0"
              task="{mtc_task}"
              trajectory_sampling_rate="100"
              velocity_scale_factor="1.000000"
            />
            <Action
              ID="SetupMTCPlanToPose"
              ik_frame="tool0"
              keep_orientation="false"
              keep_orientation_link_names="tool0"
              keep_orientation_tolerance="0.100000"
              link_padding="0.0100000"
              max_iterations="5000"
              monitored_stage="current state"
              planning_group_name="manipulator"
              target_pose="{drop_pose}"
              task="{mtc_task}"
              trajectory_sampling_rate="100"
              velocity_scale_factor="1.000000"
              acceleration_scale_factor="0.5"
            />
            <Action
              ID="PlanMTCTask"
              solution="{mtc_solution}"
              task="{mtc_task}"
            />
            <Action
              ID="ExecuteMTCTask"
              goal_duration_tolerance="-1.000000"
              solution="{mtc_solution}"
            />
            <SubTree ID="Deactivate Vacuum" _collapsed="true" />
            <SubTree
              ID="Detach and Remove Tool"
              _collapsed="true"
              tool_name="single_bracket_part"
            />
          </Control>
        </Control>
      </Decorator>
      <SubTree ID="Visualize Bins and Jig" _collapsed="true" />
      <!--Stow vacuum gripper-->
      <SubTree ID="Automated Return Held Tool" _collapsed="true" />
      <SubTree
        ID="Move to Waypoint"
        _collapsed="true"
        acceleration_scale_factor="1.0"
        controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
        controller_names="joint_trajectory_controller"
        joint_group_name="manipulator"
        keep_orientation="false"
        keep_orientation_tolerance="0.05"
        link_padding="0.01"
        seed="0"
        velocity_scale_factor="1.0"
        waypoint_name="Home"
      />
      <!--Cleanup planning scene-->
      <Action ID="ClearSnapshot" />
      <SubTree ID="Reset Planning Scene" collapsed="true" _collapsed="true" />
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Pick and Place Brackets from Left Bin">
      <MetadataFields>
        <Metadata runnable="true" />
        <Metadata subcategory="Application - Advanced Examples" />
      </MetadataFields>
    </SubTree>
  </TreeNodesModel>
</root>
