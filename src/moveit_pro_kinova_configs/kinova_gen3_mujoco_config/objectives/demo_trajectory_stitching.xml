<?xml version="1.0" encoding="utf-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Demo Trajectory Stitching">
  <!--//////////-->
  <BehaviorTree
    ID="Demo Trajectory Stitching"
    _description="Stitch two trajectories together. Extract a joint state at a give time from an existing trajectory, generate a new trajectory from that joint state, and then interrupt the first trajectory at the same time (and joint state) the stitch trajectory was generated from."
    _favorite="false"
    _subtreeOnly="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <!--For demo objectives, we start the robot at a known position-->
      <SubTree
        ID="Move to Waypoint"
        _collapsed="true"
        joint_group_name="manipulator"
        planner_interface="moveit_default"
        controller_names="/joint_trajectory_controller"
        waypoint_name="Home"
        acceleration_scale_factor="1.0"
        controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
        keep_orientation="false"
        keep_orientation_tolerance="0.05"
        link_padding="0.01"
        velocity_scale_factor="1.0"
      />
      <!--Get the most recent information on the robot and its environment-->
      <Action
        ID="GetCurrentPlanningScene"
        planning_scene_msg="{planning_scene}"
      />
      <!--Get the current values of the robot joints, and unpack them on to the blackboard-->
      <Action
        ID="GetRobotJointState"
        planning_group_name="manipulator"
        planning_scene="{planning_scene}"
        joint_state="{start_joint_state}"
      />
      <Action
        ID="UnpackJointStateMessage"
        joint_state="{start_joint_state}"
        effort="{start_effort}"
        header="{start_header}"
        name_="{joint_names}"
        position="{start_position}"
        velocity="{start_velocity}"
      />
      <!--Create a RobotJointState for the current and final joint states-->
      <Action
        ID="CreateJointState"
        joint_state_msg="{start_state}"
        positions="{start_position}"
        joint_names="{joint_names}"
        velocities="{start_velocity}"
      />
      <Action
        ID="CreateJointState"
        positions="0.5;0.51;-3.025;-2.31;0.2;1.159;1.37"
        joint_names="{joint_names}"
        joint_state_msg="{target_state}"
        velocities="0.0;0.0;0.0;0.0;0.0;0.0;0.0"
      />
      <!--Generate a trajectory from the robot start state to the end state-->
      <Action
        ID="GeneratePointToPointTrajectory"
        jerk_scale_factor="0.5"
        velocity_scale_factor="1.0"
        acceleration_scale_factor="1.0"
        planning_group_name="manipulator"
        start_state="{start_state}"
        start_time="0.000000"
        target_state="{target_state}"
        trajectory_sampling_rate="100"
        joint_trajectory_msg="{joint_trajectory_msg}"
      />
      <!--Execute the initial trajectory, stitching in a new trajectory to a new target state-->
      <Action
        ID="CreateJointState"
        positions="-0.5;-0.51;-3.025;-2.31;0.2;1.159;1.37"
        joint_names="{joint_names}"
        joint_state_msg="{stitch_target_state}"
        velocities="0.0;0.0;0.0;0.0;0.0;0.0;0.0"
      />
      <SubTree
        ID="Stitch Joint Trajectory"
        joint_names="{joint_names}"
        joint_trajectory_msg="{joint_trajectory_msg}"
        start_time="0.8"
        stitch_target_state="{stitch_target_state}"
        _collapsed="false"
      />
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Demo Trajectory Stitching">
      <MetadataFields>
        <Metadata runnable="true" />
      </MetadataFields>
    </SubTree>
  </TreeNodesModel>
</root>
