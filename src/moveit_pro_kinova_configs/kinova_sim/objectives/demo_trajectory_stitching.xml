<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="Demo Trajectory Stitching">
  <!--//////////-->
  <BehaviorTree
    ID="Demo Trajectory Stitching"
    _description="Demonstrated trajectory stitching using the JTAC: while the JTAC is executing a trajectory, send a new trajectory that can be stitched to the active trajectory."
    _favorite="false"
  >
    <Control ID="Sequence" name="TopLevelSequence">
      <Action
        ID="LogMessage"
        log_level="warn"
        message="There will be an error when the stiching occurs and the first goal is aborted, this is expected."
      />
      <SubTree
        ID="Move to Waypoint"
        _collapsed="true"
        joint_group_name="manipulator"
        controller_names="joint_trajectory_controller"
        waypoint_name="Home"
        acceleration_scale_factor="1.0"
        controller_action_server="/joint_trajectory_controller/follow_joint_trajectory"
        keep_orientation="false"
        keep_orientation_tolerance="0.05"
        link_padding="0.01"
        velocity_scale_factor="1.0"
        seed="0"
      />
      <Action
        ID="GetCurrentPlanningScene"
        planning_scene_msg="{planning_scene}"
      />
      <Action
        ID="GetRobotJointState"
        planning_group_name="manipulator"
        planning_scene="{planning_scene}"
        joint_state="{start_joint_state}"
      />
      <Action
        ID="UnpackJointStateMessage"
        joint_state="{start_joint_state}"
        effort="{start_effort}"
        header="{start_header}"
        name_="{joint_names}"
        position="{start_position}"
        velocity="{start_velocity}"
      />
      <Action
        ID="CreateJointState"
        joint_state_msg="{start_state}"
        positions="{start_position}"
        joint_names="{joint_names}"
        velocities="{start_velocity}"
      />
      <Action
        ID="CreateJointState"
        positions="0.5;0.51;-3.025;-2.31;0.2;1.159;1.37"
        joint_names="{joint_names}"
        joint_state_msg="{target_state}"
        velocities="0.0;0.0;0.0;0.0;0.0;0.0;0.0"
      />
      <Action
        ID="GetRobotJointState"
        planning_group_name="manipulator"
        planning_scene="{planning_scene}"
        joint_state="{joint_state}"
      />
      <Action
        ID="CreateJointState"
        positions="-0.5;-0.51;-3.025;-2.31;0.2;1.159;1.37"
        joint_names="{joint_names}"
        joint_state_msg="{stitch_target_state}"
        velocities="0.0;0.0;0.0;0.0;0.0;0.0;0.0"
      />
      <Action
        ID="GeneratePointToPointTrajectory"
        jerk_scale_factor="0.5"
        velocity_scale_factor="1.0"
        acceleration_scale_factor="1.0"
        planning_group_name="manipulator"
        start_state="{start_state}"
        start_time="0.000000"
        target_state="{target_state}"
        trajectory_sampling_rate="100"
        joint_trajectory_msg="{joint_trajectory_msg}"
      />
      <Action
        ID="GetTrajectoryStateAtTime"
        time_from_reference="0.8"
        joint_state="{stitch_state}"
        from_start="true"
        joint_trajectory_msg="{joint_trajectory_msg}"
      />
      <Action
        ID="GeneratePointToPointTrajectory"
        start_state="{stitch_state}"
        target_state="{stitch_target_state}"
        joint_trajectory_msg="{stitch_joint_trajectory_msg}"
        velocity_scale_factor="1.0"
        start_time="0.8"
        acceleration_scale_factor="1.0"
        jerk_scale_factor="0.5"
        planning_group_name="manipulator"
        trajectory_sampling_rate="100"
      />
      <Action
        ID="SetAdmittanceParameters"
        config_file_name="admittance_parameters_no_admittance.yaml"
        admittance_parameters_msg="{admittance_parameters_msg}"
      />
      <Action
        ID="SwitchController"
        activate_controllers="joint_trajectory_admittance_controller"
        activate_asap="true"
        automatic_deactivation="true"
        controller_list_action_name="/controller_manager/list_controllers"
        controller_switch_action_name="/controller_manager/switch_controller"
        strictness="1"
        timeout="0.000000"
      />
      <Control ID="Parallel" failure_count="2" success_count="1">
        <Action
          ID="ExecuteTrajectoryWithAdmittance"
          path_position_tolerance="0.2"
          absolute_force_torque_threshold="45;45;45;10;10;10"
          admittance_parameters_msg="{admittance_parameters_msg}"
          controller_action_name="/joint_trajectory_admittance_controller/follow_joint_trajectory"
          goal_duration_tolerance="-1.000000"
          goal_position_tolerance="0.001000"
          joint_trajectory_msg="{joint_trajectory_msg}"
        />
        <Decorator ID="Delay" delay_msec="400">
          <Action
            ID="ExecuteTrajectoryWithAdmittance"
            joint_trajectory_msg="{stitch_joint_trajectory_msg}"
            absolute_force_torque_threshold="45;45;45;10;10;10"
            goal_position_tolerance="0.001000"
            path_position_tolerance="0.2"
            admittance_parameters_msg="{admittance_parameters_msg}"
            controller_action_name="/joint_trajectory_admittance_controller/follow_joint_trajectory"
            goal_duration_tolerance="-1.000000"
          />
        </Decorator>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Demo Trajectory Stitching">
      <MetadataFields>
        <Metadata runnable="true" />
        <Metadata subcategory="Application - Advanced Examples" />
      </MetadataFields>
    </SubTree>
  </TreeNodesModel>
</root>
